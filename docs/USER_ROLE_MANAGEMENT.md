# 用户角色管理功能设计文档

## 一、概述

用户角色管理是基于 `apiKey` 的账号登录逻辑，实现用户账号隔离和角色管理。用户通过输入 `apiKey` 登录后，可以管理自己的用户角色和伙伴角色。

## 二、核心概念

### 2.1 账号逻辑

- **apiKey = 用户账号**：每个 `apiKey` 代表一个独立的用户账号
- **全局 apiKey**：用户登录时输入的 `apiKey`，用于：
  - 查询该账号下的所有角色（用户角色和伙伴角色）
  - 作为用户角色的大模型配置中的固定 `apiKey`
- **用户角色**：代表用户自己的角色，有头像、名称、位置、缩放等配置
- **伙伴角色**：代表 AI 助手的角色（原"角色管理"功能）

### 2.2 角色类型

1. **用户角色**（User Role）
   - 字段：apiKey（固定，使用登录的apiKey）、头像、角色名称（可选）、位置、缩放
   - 用途：代表用户自己，在对话历史中显示为"我"

2. **伙伴角色**（Partner Role，原"角色管理"）
   - 字段：user、type、name、description、avatar、positionX、positionY、scale、baseURL、model、apiKey
   - 用途：代表 AI 助手，在对话历史中显示为 AI 角色名称
   - **大模型设置**：
     - 伙伴角色的大模型设置（baseURL、model、apiKey）使用用户角色的设置
     - 在编辑界面中可以隐藏这些字段（UI 不显示），但数据库保留对应字段
     - 保留字段的目的是为了将来可能为不同角色选用不同模型

## 三、功能流程

### 3.1 登录流程

1. 用户点击菜单中的"用户角色管理"
2. 弹出输入框，要求用户输入 `apiKey`
3. 用户输入并确认后：
   - 保存为全局 `apiKey`（用于后续查询）
   - 加载该 `apiKey` 下的用户角色列表
   - 如果已有用户角色，显示列表；如果没有，提示创建

### 3.2 用户角色管理

#### 3.2.1 创建/编辑用户角色

**创建编辑面板包括：**

1. **大模型设置**
   - API Base URL（可选）
   - 模型名称（可选）
   - API Key：**固定显示登录的 apiKey**（不可编辑，仅显示）
   - **说明**：用户角色的大模型设置会作为全局设置，伙伴角色也会使用这些设置

2. **角色信息**
   - 头像：支持上传或输入 URL
     - 头像会作为对话历史中的缩略图显示
     - 使用立绘原图缩小显示，不需要单独存储缩略图
   - 角色名称：可选
     - 如果未设置，对话历史中显示"我"

3. **显示设置**
   - 水平位置（0-100%）
   - 垂直位置（0-100%）
   - 缩放比例（0.5-2.0）

#### 3.2.2 设置当前用户角色

- 用户可以选择一个用户角色设为当前角色
- 设置后：
  - 其他菜单（伙伴角色管理、对话历史等）变为可用
  - 只显示该 `apiKey` 下的伙伴角色列表
  - 对话历史中使用该用户角色的头像和名称

### 3.3 伙伴角色管理

- 功能保持不变（原"角色管理"功能）
- **重要：只加载用户 apiKey 对应的角色**
  - 设计原则：角色面板只显示当前登录用户（apiKey）对应的伙伴角色
  - 实现方式：查询伙伴角色时，使用当前登录的 `apiKey` 作为过滤条件
  - 确保不同用户之间的角色数据完全隔离
- 创建/编辑伙伴角色时，使用当前登录的 `apiKey` 作为 `userId` 的一部分
- **大模型设置**：
  - **UI 隐藏**：伙伴角色编辑界面中，大模型设置字段（baseURL、model、apiKey）在 UI 中隐藏
  - **数据库保留**：数据库表结构中保留这些字段（baseURL、model、apiKey），以备将来可能为不同角色选用不同模型
  - **当前实现**：伙伴角色使用用户角色的大模型设置
  - **扩展性**：保留字段的目的是为了将来可能为不同角色选用不同模型

## 四、显示逻辑

### 4.1 对话历史中的角色头像

1. **用户消息**（role='user'）
   - 显示当前用户角色的头像（如果设置了头像）
   - 如果没有设置头像，则不显示头像，也没有切换显示/隐藏的功能
   - 如果设置了头像，点击头像：显示/隐藏（toggle）用户立绘
   - 角色名称显示逻辑：
     - 如果用户角色设置了名称，显示该名称
     - 如果没有设置名称，显示"我"
     - **重要规则**：如果角色名称为空，使用 `user` 字段代替角色名称，但不能反过来（即不能使用角色名称代替 `user` 字段）

2. **AI 消息**（role='assistant'）
   - 显示当前伙伴角色的头像（如果设置了头像）
   - 如果没有设置头像，则不显示头像，也没有切换显示/隐藏的功能
   - **点击头像行为**（根据伙伴角色类型区分）：
     - **立绘类型**（type='illustration'）：点击头像显示/隐藏（toggle）伙伴立绘本体
     - **数字人类型**（type='digital_human'）：点击头像显示/隐藏数字人（通过连接/断开控制，已连接则断开隐藏，未连接则连接显示）
   - 角色名称显示逻辑：
     - 如果伙伴角色设置了名称，显示该名称
     - 如果没有设置名称，显示"AI"
     - **重要规则**：如果角色名称为空，使用 `user` 字段代替角色名称，但不能反过来（即不能使用角色名称代替 `user` 字段）

### 4.2 头像显示规则

- **头像来源**：使用立绘图片的缩略图
- **缩略图生成**：直接缩小使用立绘原图，不需要专门存储缩略图
- **显示条件**：
  - 只有设置了头像（avatar 字段不为空）的角色才显示头像
  - 没有头像的角色不显示头像，也不显示切换按钮

### 4.3 立绘与数字人显示

- **立绘显示**：
  - 用户立绘和伙伴立绘（type='illustration'）可以**同时显示**
  - 每个立绘按照各自角色配置的位置和缩放显示
  - **切换逻辑**：
    - 只有设置了头像的角色，对话历史中才显示头像
    - 点击头像可以 toggle 对应立绘的显示/隐藏
    - 没有头像的角色，不显示头像，也没有切换功能
  - 立绘显示在 `AvatarRender.vue` 组件中

- **数字人显示**：
  - 数字人（type='digital_human'）通过 SDK 渲染在 `AvatarRender.vue` 组件中
  - **切换逻辑**：
    - 只有设置了头像的伙伴角色，对话历史中才显示头像
    - 点击头像：如果数字人未连接则连接，如果已连接则断开
    - 没有头像的角色，不显示头像，也没有切换功能
  - **其他规则**：数字人角色的其他应用规则与立绘相同（位置、缩放、头像显示等）

## 五、数据库设计

### 5.1 用户角色表（user_roles）

```sql
CREATE TABLE IF NOT EXISTS user_roles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  api_key TEXT NOT NULL,              -- 用户账号（登录的apiKey）
  name TEXT,                           -- 角色名称（可选）
  avatar TEXT,                         -- 头像URL
  position_x REAL DEFAULT 50,          -- 水平位置 (0-100)
  position_y REAL DEFAULT 50,          -- 垂直位置 (0-100)
  scale REAL DEFAULT 1.0,              -- 缩放比例 (0.5-2.0)
  base_url TEXT,                       -- 大模型API Base URL（可选）
  model TEXT,                          -- 大模型名称（可选）
  is_current INTEGER DEFAULT 0,       -- 是否为当前角色 (0/1)
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
)
```

### 5.2 伙伴角色表（roles）

- 保持现有结构不变
- `user_id` 字段使用 `apiKey` 或 `apiKey:user` 格式

## 六、API 设计

### 6.1 用户角色管理 API

#### 6.1.1 获取用户角色列表
```
GET /api/user-roles?apiKey={apiKey}
```

#### 6.1.2 创建用户角色
```
POST /api/user-roles
Body: {
  apiKey: string,
  name?: string,
  avatar?: string,
  positionX?: number,
  positionY?: number,
  scale?: number,
  baseURL?: string,
  model?: string
}
```

#### 6.1.3 更新用户角色
```
PUT /api/user-roles/:id?apiKey={apiKey}
Body: {
  name?: string,
  avatar?: string,
  positionX?: number,
  positionY?: number,
  scale?: number,
  baseURL?: string,
  model?: string
}
```

#### 6.1.4 删除用户角色
```
DELETE /api/user-roles/:id?apiKey={apiKey}
```

#### 6.1.5 设置当前用户角色
```
PUT /api/user-roles/:id/set-current?apiKey={apiKey}
```

## 七、前端实现要点

### 7.1 状态管理

- **全局 apiKey**：存储在组件状态中，用户登录后设置
- **当前用户角色**：存储在组件状态中，用于显示和配置
- **用户角色列表**：从后端加载，基于全局 apiKey

### 7.2 组件修改

1. **ConfigPanel.vue**
   - 添加用户角色管理模态框
   - 添加登录输入框（首次打开时）
   - 添加用户角色创建/编辑表单
   - 修改伙伴角色管理，只显示当前 apiKey 下的角色

2. **AvatarRender.vue**
   - 支持同时显示用户立绘和伙伴立绘
   - 根据 toggle 状态控制显示/隐藏
   - 根据角色配置设置位置和缩放

3. **对话历史组件**
   - 添加角色头像显示（仅当角色设置了头像时显示）
   - 头像使用立绘原图缩小显示（CSS 控制大小，不存储缩略图）
   - 添加头像点击事件，toggle 立绘显示（仅当有头像时）
   - 角色名称显示：
     - 用户角色：有名称显示名称，无名称显示"我"
     - 伙伴角色：有名称显示名称，无名称显示"AI"

## 八、开发步骤

1. **数据库设计**
   - 创建 `user_roles` 表
   - 添加相关索引

2. **后端 API 实现**
   - 实现用户角色 CRUD API
   - 实现设置当前角色 API

3. **前端登录流程**
   - 实现 apiKey 输入确认
   - 实现全局 apiKey 存储

4. **用户角色管理 UI**
   - 实现用户角色列表
   - 实现用户角色创建/编辑表单
   - 实现设置当前角色功能

5. **显示逻辑实现**
   - 对话历史中添加头像
   - 实现立绘 toggle 功能
   - 实现同时显示用户和伙伴立绘

6. **集成测试**
   - 测试登录流程
   - 测试用户角色管理
   - 测试立绘显示/隐藏
   - 测试伙伴角色过滤

## 九、注意事项

1. **apiKey 安全性**
   - apiKey 存储在内存中，不持久化到 localStorage
   - 刷新页面后需要重新登录

2. **数据隔离**
   - 所有查询都基于 apiKey 进行过滤
   - 确保不同 apiKey 的数据完全隔离

3. **当前角色**
   - 每个 apiKey 只能有一个当前用户角色
   - 设置新角色为当前时，自动取消其他角色的当前状态

4. **立绘显示**
   - 用户立绘和伙伴立绘可以同时显示
   - 需要合理处理位置，避免重叠
   - 只有设置了头像的角色才能切换立绘显示/隐藏

5. **头像显示**
   - 头像使用立绘原图，通过 CSS 缩小显示
   - 不存储缩略图，节省存储空间
   - 没有头像的角色不显示头像，也不显示切换按钮

6. **大模型设置**
   - 伙伴角色的大模型设置字段在 UI 中隐藏
   - 数据库保留字段，以备将来扩展
   - 当前实现使用用户角色的大模型设置

7. **角色数据隔离（重要）**
   - **设计原则**：只加载用户 apiKey 对应的角色
   - 角色面板（用户角色和伙伴角色）只显示当前登录用户（apiKey）对应的角色
   - 确保不同用户之间的角色数据完全隔离
   - 查询角色时，必须使用当前登录的 `apiKey` 作为过滤条件

8. **角色名称显示规则**
   - **重要规则**：如果角色名称为空，使用 `user` 字段代替角色名称
   - **单向规则**：不能反过来，即不能使用角色名称代替 `user` 字段
   - 用户角色：名称为空时显示"我"（或使用 user 字段）
   - 伙伴角色：名称为空时显示"AI"（或使用 user 字段）

9. **伙伴角色大模型设置**
   - **UI 隐藏**：编辑界面中隐藏大模型设置字段（baseURL、model、apiKey）
   - **数据库保留**：数据库表结构中保留这些字段，以备后续扩展
   - **扩展性**：保留字段的目的是为了将来可能为不同角色选用不同模型

