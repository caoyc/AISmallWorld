# TTS模块实现检查清单

## 一、数据结构扩展

### 1.1 类型定义
- [ ] 在 `src/types/index.ts` 中为 `Role` 接口添加TTS字段
  - [ ] `ttsProvider?: 'doubao' | string`
  - [ ] `ttsVoice?: string`
  - [ ] `ttsSpeed?: number`
  - [ ] `ttsVolume?: number`
- [ ] 在 `src/types/index.ts` 中为 `UserRole` 接口添加TTS字段（同上）
- [ ] 创建TTS相关类型定义
  - [ ] `TtsConfig` 接口
  - [ ] `TtsService` 接口

### 1.2 数据库扩展
- [ ] 在 `server/db.js` 中添加数据库迁移脚本
  - [ ] `roles` 表添加字段：
    - [ ] `tts_provider TEXT DEFAULT 'doubao'`
    - [ ] `tts_voice TEXT`
    - [ ] `tts_speed REAL DEFAULT 1.0`
    - [ ] `tts_volume REAL DEFAULT 1.0`
  - [ ] `user_roles` 表添加字段（同上）
- [ ] 更新 `createRole` 函数，支持TTS字段
- [ ] 更新 `updateRole` 函数，支持TTS字段
- [ ] 更新 `createUserRole` 函数，支持TTS字段
- [ ] 更新 `updateUserRole` 函数，支持TTS字段
- [ ] 更新 `getRoles` 函数，返回TTS字段
- [ ] 更新 `getUserRoles` 函数，返回TTS字段

## 二、TTS服务实现

### 2.1 服务层创建
- [ ] 创建 `src/services/tts.ts` 文件
- [ ] 实现 `TtsService` 接口
- [ ] 实现 `DoubaoTtsService` 类
  - [ ] `synthesize` 方法实现
  - [ ] API Key解析（AppID:AccessToken）
  - [ ] 请求构建和发送
  - [ ] 响应解析（base64转ArrayBuffer）
  - [ ] 错误处理
- [ ] 实现 `TtsServiceFactory` 工厂类

### 2.2 常量定义
- [ ] 创建 `src/constants/tts.ts` 文件
- [ ] 定义 `DOUBAO_VOICES` 音色列表
  - [ ] 包含常用音色（至少6个）
  - [ ] 每个音色包含：id、name、gender

## 三、UI实现

### 3.1 编辑面板扩展（伙伴角色）
- [ ] 在 `ConfigPanel.vue` 中添加TTS配置区域
  - [ ] 条件显示：`v-if="roleForm.type === 'illustration'"`
  - [ ] TTS引擎选择下拉框
  - [ ] 音色选择下拉框
  - [ ] 音色试听按钮
  - [ ] 语速滑块
  - [ ] 音量滑块
- [ ] 更新 `roleForm` 初始化，包含TTS字段
- [ ] 更新 `handleEditRole`，加载TTS字段
- [ ] 更新 `handleSaveRole`，保存TTS字段

### 3.2 编辑面板扩展（用户角色）
- [ ] 在 `ConfigPanel.vue` 中添加TTS配置区域（同上）
  - [ ] 条件显示：`v-if="userRoleForm.type === 'illustration'"`
- [ ] 更新 `userRoleForm` 初始化，包含TTS字段
- [ ] 更新 `handleEditUserRole`，加载TTS字段
- [ ] 更新 `handleSaveUserRole`，保存TTS字段

### 3.3 试听功能实现
- [ ] 实现 `previewVoice` 函数
  - [ ] 获取当前音色配置
  - [ ] 调用TTS服务生成测试音频
  - [ ] 播放试听音频
  - [ ] 错误处理

## 四、播放功能实现

### 4.1 播放逻辑修改
- [ ] 修改 `playMessageAudio` 函数
  - [ ] 判断角色类型
  - [ ] 数字人：使用现有逻辑（`digitalHumanInstance.speak`）
  - [ ] 立绘：调用豆包TTS服务
- [ ] 实现音频播放函数
  - [ ] `playAudio` 函数实现
  - [ ] 使用 `Audio` API播放
  - [ ] 播放状态管理
  - [ ] 播放完成处理
  - [ ] 播放错误处理
- [ ] 更新 `stopMessageAudio` 函数
  - [ ] 停止音频播放
  - [ ] 清除播放状态

### 4.2 配置获取逻辑
- [ ] 实现角色TTS配置获取逻辑
  - [ ] 优先使用角色配置
  - [ ] 角色配置缺失时使用全局配置
  - [ ] 默认值处理

## 五、测试

### 5.1 功能测试
- [ ] 数字人角色播放消息音频（使用SDK TTS）
- [ ] 立绘角色播放消息音频（使用豆包TTS）
- [ ] 音色设置和保存
- [ ] 音色试听功能
- [ ] 语速和音量调整

### 5.2 边界测试
- [ ] 未配置API Key时的提示
- [ ] 未选择音色时的默认值
- [ ] 音频播放失败的处理
- [ ] 文本过长时的处理（如果支持分段）

### 5.3 兼容性测试
- [ ] 旧角色数据（没有TTS字段）的兼容性
- [ ] 数据库迁移的正确性
- [ ] 角色类型切换时的TTS配置处理

## 六、文档

### 6.1 开发文档
- [x] TTS模块开发方案.md
- [x] 豆包TTS API调用文档.md
- [x] 实现检查清单.md（本文件）

### 6.2 代码注释
- [ ] TTS服务类添加详细注释
- [ ] 关键函数添加注释
- [ ] API调用参数说明

## 七、优化（可选）

### 7.1 性能优化
- [ ] 音频数据缓存（可选）
- [ ] 避免重复调用TTS API（可选）

### 7.2 用户体验
- [ ] 播放进度显示（可选）
- [ ] 播放速度控制（可选）
- [ ] 播放列表功能（可选）

