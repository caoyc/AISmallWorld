# 角色语音播放控制功能设计

## 一、需求概述

### 1.1 功能目标
在角色编辑面板中添加语音播放相关的控制选项，支持用户自定义语音播放行为和角色显示切换逻辑。

### 1.2 核心需求

1. **启用语音播放**
   - 控制是否允许播放该角色的语音
   - 默认启用
   - 影响：如果禁用，点击播放按钮时不会播放该角色的语音

2. **启用自动播放**
   - 控制新消息是否自动播放语音
   - 默认不启用
   - 影响：如果启用，收到新消息时自动播放语音（需要同时满足"启用语音播放"）

3. **自动切换角色**
   - 根据当前说话人自动显示/隐藏角色
   - 默认不启用
   - 影响：如果启用，会根据当前说话人自动切换角色显示状态

## 二、当前说话人判断标准

### 2.1 判断时机

1. **语音播放前切换**
   - 时机：调用 `playMessageAudio` 函数时，在播放语音之前
   - 判断标准：当前播放语音的角色（`message.role === 'user' ? appState.currentUserRole : appState.currentPartnerRole`）
   - 操作：显示当前说话人的角色，隐藏另一个角色

2. **显示最新消息时切换**
   - 时机：收到新消息并添加到 `appState.chatHistory` 后，显示消息时
   - 判断标准：当前消息的角色（`message.role === 'user'` 或 `message.role === 'assistant'`）
   - 操作：显示当前消息发送者的角色，隐藏另一个角色

### 2.2 切换逻辑

- **显示当前说话人**：设置 `role.showDigitalHuman = true` 或 `role.showIllustration = true`（根据角色类型）
- **隐藏另一个角色**：设置另一个角色的 `showDigitalHuman = false` 或 `showIllustration = false`

## 三、数据结构设计

### 3.1 角色类型扩展

在 `Role` 和 `UserRole` 接口中添加控制字段：

```typescript
export interface Role {
  // ... 现有字段 ...
  
  // 语音播放控制（仅立绘类型使用）
  enableVoicePlay?: boolean      // 启用语音播放，默认true
  enableAutoPlay?: boolean       // 启用自动播放，默认false
  enableAutoSwitch?: boolean    // 自动切换角色，默认false
}

export interface UserRole {
  // ... 现有字段 ...
  
  // 语音播放控制（仅立绘类型使用）
  enableVoicePlay?: boolean      // 启用语音播放，默认true
  enableAutoPlay?: boolean       // 启用自动播放，默认false
  enableAutoSwitch?: boolean    // 自动切换角色，默认false
}
```

### 3.2 数据库字段扩展

在 `roles` 和 `user_roles` 表中添加字段：

```sql
-- roles 表
ALTER TABLE roles ADD COLUMN enable_voice_play INTEGER DEFAULT 1;
ALTER TABLE roles ADD COLUMN enable_auto_play INTEGER DEFAULT 0;
ALTER TABLE roles ADD COLUMN enable_auto_switch INTEGER DEFAULT 0;

-- user_roles 表
ALTER TABLE user_roles ADD COLUMN enable_voice_play INTEGER DEFAULT 1;
ALTER TABLE user_roles ADD COLUMN enable_auto_play INTEGER DEFAULT 0;
ALTER TABLE user_roles ADD COLUMN enable_auto_switch INTEGER DEFAULT 0;
```

## 四、UI设计

### 4.1 编辑面板布局

在立绘角色的编辑面板中，TTS配置区域之后添加"语音播放控制"区域：

```vue
<!-- 语音播放控制（仅当角色类型为立绘时显示） -->
<div v-if="roleForm.type === 'illustration'">
  <div class="config-divider"></div>
  <div class="config-section">
    <h4 class="section-title">语音播放控制</h4>
    
    <!-- 启用语音播放 -->
    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 8px;">
        <input 
          type="checkbox" 
          v-model="roleForm.enableVoicePlay"
        />
        <span>启用语音播放</span>
      </label>
      <small class="form-hint">禁用后，点击播放按钮时不会播放该角色的语音</small>
    </div>
    
    <!-- 启用自动播放 -->
    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 8px;">
        <input 
          type="checkbox" 
          v-model="roleForm.enableAutoPlay"
        />
        <span>启用自动播放</span>
      </label>
      <small class="form-hint">启用后，收到新消息时自动播放语音（需要同时启用"启用语音播放"）</small>
    </div>
    
    <!-- 自动切换角色 -->
    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 8px;">
        <input 
          type="checkbox" 
          v-model="roleForm.enableAutoSwitch"
        />
        <span>自动切换角色</span>
      </label>
      <small class="form-hint">启用后，根据当前说话人自动显示/隐藏角色</small>
    </div>
  </div>
</div>
```

### 4.2 用户角色编辑面板

用户角色编辑面板中添加相同的"语音播放控制"区域（使用 `userRoleForm`）。

## 五、功能实现逻辑

### 5.1 启用语音播放

**影响位置：**
- `playMessageAudio` 函数：播放前检查 `role.enableVoicePlay`，如果为 `false`，提示并返回

**实现逻辑：**
```typescript
async function playMessageAudio(message: ChatMessage, index: number) {
  const role = message.role === 'user' 
    ? appState.currentUserRole 
    : appState.currentPartnerRole
  
  if (!role) {
    showToastMessage('角色不存在', 'error')
    return
  }
  
  // 检查是否启用语音播放
  if (role.enableVoicePlay === false) {
    showToastMessage('该角色已禁用语音播放', 'info')
    return
  }
  
  // ... 后续播放逻辑
}
```

### 5.2 启用自动播放

**影响位置：**
- `sendMessage` 函数：发送消息后，如果收到回复且 `enableAutoPlay` 为 `true`，自动播放回复语音

**实现逻辑：**
```typescript
async function sendMessage() {
  // ... 发送消息逻辑 ...
  
  // 收到回复后
  if (responseMessage) {
    // 检查是否启用自动播放
    const replyRole = appState.currentPartnerRole
    if (replyRole?.enableAutoPlay && replyRole?.enableVoicePlay !== false) {
      // 自动播放回复语音
      const messageIndex = appState.chatHistory.length - 1
      await playMessageAudio(responseMessage, messageIndex)
    }
  }
}
```

### 5.3 自动切换角色

**影响位置：**
1. `playMessageAudio` 函数：播放前切换角色显示
2. `sendMessage` 函数：显示新消息时切换角色显示

**实现逻辑：**

#### 5.3.1 播放前切换

```typescript
async function playMessageAudio(message: ChatMessage, index: number) {
  const role = message.role === 'user' 
    ? appState.currentUserRole 
    : appState.currentPartnerRole
  
  if (!role) {
    showToastMessage('角色不存在', 'error')
    return
  }
  
  // 自动切换角色（如果启用）
  if (role.enableAutoSwitch) {
    await switchRoleDisplay(message.role)
  }
  
  // ... 后续播放逻辑
}

// 切换角色显示
async function switchRoleDisplay(messageRole: 'user' | 'assistant') {
  if (messageRole === 'user') {
    // 显示用户角色，隐藏伙伴角色
    if (appState.currentUserRole) {
      if (appState.currentUserRole.type === 'digital_human') {
        appState.currentUserRole.showDigitalHuman = true
      } else {
        // 立绘显示逻辑（通过 showUserIllustration）
        showUserIllustration.value = true
      }
    }
    
    if (appState.currentPartnerRole) {
      if (appState.currentPartnerRole.type === 'digital_human') {
        appState.currentPartnerRole.showDigitalHuman = false
      } else {
        showPartnerIllustration.value = false
      }
    }
  } else {
    // 显示伙伴角色，隐藏用户角色
    if (appState.currentPartnerRole) {
      if (appState.currentPartnerRole.type === 'digital_human') {
        appState.currentPartnerRole.showDigitalHuman = true
      } else {
        showPartnerIllustration.value = true
      }
    }
    
    if (appState.currentUserRole) {
      if (appState.currentUserRole.type === 'digital_human') {
        appState.currentUserRole.showDigitalHuman = false
      } else {
        showUserIllustration.value = false
      }
    }
  }
}
```

#### 5.3.2 显示新消息时切换

```typescript
async function sendMessage() {
  // ... 发送消息逻辑 ...
  
  // 添加用户消息到历史
  appState.chatHistory.push({
    role: 'user',
    content: messageContent,
    timestamp: Date.now()
  })
  
  // 自动切换角色（如果启用）
  if (appState.currentUserRole?.enableAutoSwitch) {
    await switchRoleDisplay('user')
  }
  
  // ... 等待回复 ...
  
  // 收到回复后
  if (responseMessage) {
    appState.chatHistory.push(responseMessage)
    
    // 自动切换角色（如果启用）
    if (appState.currentPartnerRole?.enableAutoSwitch) {
      await switchRoleDisplay('assistant')
    }
    
    // 自动播放（如果启用）
    if (appState.currentPartnerRole?.enableAutoPlay && appState.currentPartnerRole?.enableVoicePlay !== false) {
      const messageIndex = appState.chatHistory.length - 1
      await playMessageAudio(responseMessage, messageIndex)
    }
  }
}
```

## 六、实现步骤

### 6.1 第一阶段：数据结构扩展

1. **类型定义扩展**
   - 在 `src/types/index.ts` 中为 `Role` 和 `UserRole` 添加控制字段

2. **数据库扩展**
   - 在 `server/db.js` 中添加数据库迁移脚本
   - 更新所有数据库函数以支持新字段

3. **后端API扩展**
   - 更新角色创建/更新接口，支持新字段的保存和读取

### 6.2 第二阶段：UI实现

1. **编辑面板扩展**
   - 在伙伴角色编辑面板中添加"语音播放控制"区域
   - 在用户角色编辑面板中添加"语音播放控制"区域
   - 更新表单初始化和保存逻辑

### 6.3 第三阶段：功能实现

1. **启用语音播放**
   - 修改 `playMessageAudio` 函数，添加检查逻辑

2. **启用自动播放**
   - 修改 `sendMessage` 函数，添加自动播放逻辑

3. **自动切换角色**
   - 实现 `switchRoleDisplay` 函数
   - 在 `playMessageAudio` 和 `sendMessage` 中调用切换逻辑

## 七、注意事项

1. **默认值处理**
   - `enableVoicePlay` 默认值为 `true`（启用）
   - `enableAutoPlay` 默认值为 `false`（不启用）
   - `enableAutoSwitch` 默认值为 `false`（不启用）

2. **依赖关系**
   - `enableAutoPlay` 依赖于 `enableVoicePlay`：如果 `enableVoicePlay` 为 `false`，即使 `enableAutoPlay` 为 `true`，也不会自动播放

3. **角色类型限制**
   - 这些控制选项仅对立绘类型有效（数字人使用SDK自带的TTS，不受这些选项控制）
   - UI中应使用 `v-if="roleForm.type === 'illustration'"` 条件显示

4. **切换时机**
   - 语音播放前切换：在 `playMessageAudio` 函数开始处，播放前切换
   - 显示新消息时切换：在 `sendMessage` 函数中，添加消息到历史后立即切换

5. **状态同步**
   - 切换角色显示时，需要同时更新 `showDigitalHuman`（数字人）和 `showIllustration`（立绘）状态
   - 确保 `appState.currentUserRole` 和 `appState.currentPartnerRole` 的状态同步更新

6. **用户体验**
   - 切换角色显示时，可以添加平滑的过渡动画（可选）
   - 禁用语音播放时，播放按钮可以显示为禁用状态或隐藏

## 八、测试要点

1. **功能测试**
   - 启用/禁用"启用语音播放"，验证播放按钮行为
   - 启用/禁用"启用自动播放"，验证新消息是否自动播放
   - 启用/禁用"自动切换角色"，验证角色显示切换逻辑

2. **边界测试**
   - 同时启用多个选项时的交互
   - 角色类型切换时的状态处理
   - 未配置选项时的默认值

3. **兼容性测试**
   - 旧角色数据（没有这些字段）的兼容性
   - 数据库迁移的正确性

