# 脚本模式设计方案

## 1. 概述

脚本模式是一种基于WebGAL的脚本播放模式，允许用户导入和播放制作好的对话脚本。该模式适用于：
- 预设剧情展示
- 互动小说/游戏
- 演示场景
- 自动化对话流程

## 2. WebGAL 简介

WebGAL是一个基于Web的视觉小说引擎，支持：
- 对话脚本
- 角色立绘显示
- 背景切换
- 音效和BGM
- 分支选择
- 变量系统

### 2.1 WebGAL脚本格式

```webgal
; 注释
角色名:对话内容
[bgm:bgm.mp3]
[bg:background.jpg]
[changeFigure:角色名,立绘路径]
[选择项1:标签1]
[选择项2:标签2]
[标签1:]
对话内容1
[标签2:]
对话内容2
```

## 3. 功能需求

### 3.1 核心功能

1. **脚本导入**
   - 支持导入WebGAL格式脚本文件
   - 支持文本粘贴
   - 脚本解析和验证

2. **脚本播放**
   - 按顺序播放对话
   - 自动切换说话人
   - 自动播放语音
   - 支持暂停/继续/停止

3. **分支选择**
   - 显示选择项
   - 用户选择后跳转到对应标签
   - 支持嵌套分支

4. **背景和音效**
   - 背景图片切换
   - BGM播放
   - 音效播放

5. **变量系统**
   - 支持变量定义和使用
   - 支持条件判断
   - 支持跳转逻辑

### 3.2 UI设计

#### 3.2.1 脚本管理界面
```
┌─────────────────────────────────────┐
│ 脚本模式                            │
│ [导入脚本] [新建脚本] [脚本列表]    │
└─────────────────────────────────────┘
```

#### 3.2.2 脚本播放界面
```
┌─────────────────────────────────────┐
│ [背景图片]                          │
│                                     │
│  [角色立绘]                         │
│                                     │
│ 角色名: 对话内容                    │
│                                     │
│ [选择项1] [选择项2]                 │
│                                     │
│ [播放] [暂停] [停止] [上一句] [下一句] │
└─────────────────────────────────────┘
```

## 4. 技术实现

### 4.1 脚本解析器

#### 4.1.1 脚本结构
```typescript
interface WebGALScript {
  commands: WebGALCommand[]    // 命令列表
  labels: Record<string, number>  // 标签索引
  variables: Record<string, any>    // 变量
}

interface WebGALCommand {
  type: 'dialogue' | 'bg' | 'bgm' | 'changeFigure' | 'choice' | 'label' | 'jump' | 'setVar' | 'if'
  content?: string
  speaker?: string
  options?: ChoiceOption[]
  target?: string
  condition?: string
  // ... 其他属性
}
```

#### 4.1.2 解析流程
```
1. 读取脚本文件或文本
2. 按行解析
3. 识别命令类型
4. 构建命令对象
5. 建立标签索引
6. 验证脚本语法
```

### 4.2 播放引擎

#### 4.2.1 播放状态
```typescript
interface PlaybackState {
  script: WebGALScript
  currentIndex: number
  isPlaying: boolean
  isPaused: boolean
  currentSpeaker: string
  currentBackground: string
  currentBGM: string
  variables: Record<string, any>
}
```

#### 4.2.2 播放流程
```
1. 初始化播放状态
2. 从当前索引读取命令
3. 执行命令：
   - dialogue: 显示对话，播放语音
   - bg: 切换背景
   - bgm: 播放BGM
   - changeFigure: 切换角色立绘
   - choice: 显示选择项，等待用户选择
   - label: 跳转到标签
   - jump: 跳转到指定位置
   - setVar: 设置变量
   - if: 条件判断
4. 执行完成后，索引+1
5. 继续执行下一条命令
6. 如果到达脚本末尾，停止播放
```

### 4.3 命令执行器

#### 4.3.1 对话命令
- 显示角色名称和对话内容
- 根据角色类型播放语音
- 等待用户点击继续（或自动继续）

#### 4.3.2 背景命令
- 切换背景图片
- 支持淡入淡出效果

#### 4.3.3 BGM命令
- 播放/停止BGM
- 支持音量控制

#### 4.3.4 选择命令
- 显示选择项按钮
- 等待用户选择
- 跳转到对应标签

#### 4.3.5 变量命令
- 设置变量值
- 条件判断
- 根据变量值跳转

## 5. 数据存储

### 5.1 脚本存储
- 创建 `scripts` 表存储脚本
- 字段：
  - id: 脚本ID
  - name: 脚本名称
  - content: 脚本内容
  - created_at: 创建时间
  - updated_at: 更新时间

### 5.2 播放记录
- 创建 `script_playback_history` 表
- 记录播放进度和变量状态

## 6. 与现有系统集成

### 6.1 角色系统
- 使用现有的角色管理
- 脚本中的角色名映射到实际角色
- 使用角色的TTS配置

### 6.2 背景系统
- 使用现有的背景管理
- 脚本中的背景名映射到实际背景

### 6.3 对话历史
- 脚本播放的对话可以记录到对话历史
- 或使用独立的脚本播放历史

## 7. 实现步骤

### 阶段1：基础解析（后续实现）
1. 实现脚本解析器
2. 支持基本命令（dialogue, label, jump）
3. 实现简单的播放引擎

### 阶段2：完整功能（后续实现）
1. 支持所有命令类型
2. 实现分支选择
3. 实现变量系统
4. 实现背景和音效

### 阶段3：UI和优化（后续实现）
1. 实现脚本管理界面
2. 实现播放界面
3. 优化播放体验
4. 错误处理和调试工具

## 8. 注意事项

1. **脚本格式**
   - 严格遵循WebGAL格式
   - 提供脚本验证功能
   - 提供脚本编辑器（可选）

2. **性能优化**
   - 脚本预解析
   - 资源预加载
   - 播放流畅性优化

3. **兼容性**
   - 与现有系统兼容
   - 不影响其他模式的使用
   - 支持脚本导入/导出

4. **扩展性**
   - 支持自定义命令
   - 支持插件系统（可选）
   - 支持脚本模板

## 9. 参考资源

- WebGAL官方文档：https://github.com/MakinoharaShoko/WebGAL
- WebGAL脚本格式规范
- 视觉小说引擎设计模式

## 10. 后续扩展

1. **脚本编辑器**
   - 可视化脚本编辑
   - 语法高亮
   - 实时预览

2. **脚本模板**
   - 提供常用脚本模板
   - 支持模板自定义

3. **脚本分享**
   - 脚本导入/导出
   - 脚本分享平台（可选）

4. **高级功能**
   - 动画效果
   - 特效系统
   - 多语言支持

