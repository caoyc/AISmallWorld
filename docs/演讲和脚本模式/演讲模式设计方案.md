# 演讲模式设计方案

## 1. 概述

演讲模式是一种不调用大模型的对话模式，允许用户手动选择说话人（当前用户角色或伙伴角色），并通过输入框直接输入说话内容。该模式适用于：
- 演示场景
- 预设对话展示
- 脚本编写和测试
- 离线使用场景

## 2. 功能需求

### 2.1 核心功能

1. **说话人选择**
   - 在对话框前添加说话人选择器
   - 可选择：当前用户角色、当前伙伴角色
   - 显示角色名称和头像（可选）

2. **内容输入**
   - 提供文本输入框
   - 支持多行输入
   - 支持Markdown格式（可选）

3. **消息发送**
   - 点击发送按钮或按Enter发送
   - 消息添加到对话历史
   - 根据说话人类型显示在对话历史中

4. **语音播放**
   - 如果说话人是立绘类型，使用TTS播放
   - 如果说话人是数字人类型，使用数字人SDK的TTS播放
   - 支持播放/停止控制

### 2.2 UI设计

#### 2.2.1 说话人选择器
```
┌─────────────────────────────────────┐
│ 说话人: [用户角色 ▼] [伙伴角色]     │
│ 头像: [头像预览]                     │
└─────────────────────────────────────┘
```

- 说话人选择：下拉选择框或按钮组
- 显示当前选择的角色信息（名称、头像）
- 角色切换时，输入框保持可用

#### 2.2.2 输入区域
```
┌─────────────────────────────────────┐
│ [文本输入框（多行）]                │
│                                     │
│                                     │
└─────────────────────────────────────┘
│ [发送] [清空]                       │
└─────────────────────────────────────┘
```

- 文本输入框：支持多行，可调整高度
- 发送按钮：发送消息
- 清空按钮：清空输入框

#### 2.2.3 对话历史显示
- 保持现有对话历史显示格式
- 根据说话人类型显示不同样式
- 用户角色消息：右侧显示
- 伙伴角色消息：左侧显示
- 显示说话人名称和头像

## 3. 技术实现

### 3.1 状态管理

#### 3.1.1 演讲模式状态
```typescript
interface SpeechModeState {
  enabled: boolean              // 是否启用演讲模式
  currentSpeaker: 'user' | 'partner'  // 当前选择的说话人
  inputText: string             // 输入框内容
}
```

#### 3.1.2 消息结构
```typescript
interface ChatMessage {
  role: 'user' | 'assistant' | 'system'
  content: string
  timestamp?: number
  speaker?: string              // 说话人标识（可选）
  speakerName?: string          // 说话人名称（可选）
}
```

### 3.2 组件设计

#### 3.2.1 说话人选择器组件
- 位置：对话框上方
- 功能：
  - 显示当前用户角色和伙伴角色
  - 允许切换说话人
  - 显示角色头像和名称

#### 3.2.2 输入框组件
- 位置：对话框下方
- 功能：
  - 多行文本输入
  - 发送消息
  - 清空输入

### 3.3 消息发送流程

```
1. 用户选择说话人（用户角色或伙伴角色）
2. 用户在输入框输入内容
3. 点击发送按钮
4. 创建消息对象：
   - role: 根据说话人类型设置（'user' 或 'assistant'）
   - content: 输入框内容
   - timestamp: 当前时间戳
   - speaker: 说话人标识
   - speakerName: 说话人名称
5. 添加到对话历史（appState.chatHistory）
6. 如果说话人是立绘类型，调用TTS播放
7. 如果说话人是数字人类型，调用数字人SDK播放
8. 清空输入框
```

### 3.4 语音播放逻辑

#### 3.4.1 立绘角色
- 使用角色的TTS配置（音色、语速、音量）
- 调用豆包TTS服务
- 播放音频

#### 3.4.2 数字人角色
- 检查数字人是否已连接
- 如果未连接，提示用户连接
- 如果已连接，使用数字人SDK的speak方法
- 生成SSML格式文本

## 4. 数据存储

### 4.1 对话历史
- 使用现有的 `chat_messages` 表
- 添加 `speaker` 字段（可选，用于标识说话人）
- 添加 `speaker_name` 字段（可选，用于显示说话人名称）

### 4.2 模式状态
- 不持久化模式状态（每次打开应用时默认关闭）
- 或保存到本地存储（localStorage）

## 5. UI/UX 设计

### 5.1 模式切换
- 在主界面添加"演讲模式"开关
- 切换时：
  - 关闭：隐藏说话人选择器，恢复大模型对话
  - 开启：显示说话人选择器，禁用大模型调用

### 5.2 输入体验
- 支持快捷键：Enter发送，Shift+Enter换行
- 输入框自动聚焦
- 发送后自动清空输入框

### 5.3 视觉反馈
- 说话人选择器高亮当前选择
- 发送按钮禁用状态（输入框为空时）
- 播放状态显示（播放中/已停止）

## 6. 实现步骤

### 阶段1：基础功能
1. 添加演讲模式开关
2. 实现说话人选择器
3. 修改输入框，支持演讲模式
4. 实现消息发送（不调用大模型）

### 阶段2：语音播放
1. 集成立绘TTS播放
2. 集成数字人TTS播放
3. 实现播放控制

### 阶段3：优化
1. UI/UX优化
2. 快捷键支持
3. 错误处理
4. 性能优化

## 7. 注意事项

1. **模式切换**
   - 切换模式时，不清空对话历史
   - 切换模式时，停止当前播放的音频

2. **角色状态**
   - 确保当前用户角色和伙伴角色已设置
   - 如果角色不存在，禁用发送功能

3. **TTS配置**
   - 立绘角色需要配置TTS（音色、语速、音量）
   - 数字人角色需要连接数字人SDK

4. **消息格式**
   - 保持与现有消息格式兼容
   - 支持Markdown格式（可选）

## 8. 后续扩展

1. **模板功能**
   - 预设常用对话模板
   - 快速插入模板内容

2. **批量输入**
   - 支持批量导入对话内容
   - 支持CSV/JSON格式导入

3. **导出功能**
   - 导出对话历史为脚本格式
   - 支持导出为WebGAL格式（为脚本模式做准备）

