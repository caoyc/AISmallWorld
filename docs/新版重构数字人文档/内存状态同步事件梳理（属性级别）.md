# å†…å­˜çŠ¶æ€åŒæ­¥äº‹ä»¶æ¢³ç†ï¼ˆå±æ€§çº§åˆ«ï¼‰

## æ ¸å¿ƒåŸåˆ™

**åƒæ“ä½œæ•°æ®åº“ä¸€æ ·ç»´æŠ¤å†…å­˜çŠ¶æ€**

æ¯ä¸ªæ“ä½œéƒ½è¦è€ƒè™‘ï¼šå¦‚æœè¿™æ˜¯æ•°æ®åº“æ“ä½œï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

### åŸåˆ™è¦ç‚¹

1. **ç²¾ç¡®æ›´æ–°**ï¼šå˜æ›´ä¸€ä¸ªè§’è‰²æ—¶ï¼Œåªæ›´æ–°é‚£ä¸ªå…·ä½“çš„è§’è‰²å¯¹è±¡ï¼Œä¸è¦é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰²
   - âŒ é”™è¯¯ï¼šæ›´æ–°ä¸€ä¸ªè§’è‰² â†’ é‡æ–°åŠ è½½æ•´ä¸ªåˆ—è¡¨
   - âœ… æ­£ç¡®ï¼šæ›´æ–°ä¸€ä¸ªè§’è‰² â†’ åªæ›´æ–°é‚£ä¸ªè§’è‰²çš„å±æ€§

2. **åŸå­æ“ä½œ**ï¼šæ¯ä¸ªæ“ä½œåº”è¯¥åªå½±å“ç›¸å…³çš„å¯¹è±¡å’Œå±æ€§
   - åˆ›å»ºè§’è‰²ï¼šåªæ·»åŠ æ–°è§’è‰²åˆ°åˆ—è¡¨
   - æ›´æ–°è§’è‰²ï¼šåªæ›´æ–°é‚£ä¸ªè§’è‰²çš„å±æ€§
   - åˆ é™¤è§’è‰²ï¼šåªä»åˆ—è¡¨ä¸­ç§»é™¤é‚£ä¸ªè§’è‰²

3. **çŠ¶æ€æ¢å¤**ï¼šåªæœ‰åœ¨å¿…è¦æ—¶æ‰ä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼ˆå¦‚ç™»å½•æ—¶ã€æ•°æ®å¯èƒ½ä¸ä¸€è‡´æ—¶ï¼‰
   - âœ… ç™»å½•æ—¶ï¼šéœ€è¦åŠ è½½æ‰€æœ‰è§’è‰²
   - âŒ æ›´æ–°ä¸€ä¸ªè§’è‰²ï¼šä¸éœ€è¦é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰²

4. **å¼•ç”¨ä¸€è‡´æ€§**ï¼šä¿æŒå¯¹è±¡å¼•ç”¨çš„ç¨³å®šæ€§
   - æ›´æ–°è§’è‰²æ—¶ï¼Œåº”è¯¥æ›´æ–°ç°æœ‰å¯¹è±¡çš„å±æ€§ï¼Œè€Œä¸æ˜¯æ›¿æ¢æ•´ä¸ªå¯¹è±¡
   - å¦‚æœå¿…é¡»æ›¿æ¢å¯¹è±¡ï¼Œéœ€è¦åŒæ­¥æ›´æ–°æ‰€æœ‰å¼•ç”¨

## æ¦‚è¿°
æœ¬æ–‡æ¡£ä»¥å±æ€§ä¸ºç²’åº¦ï¼Œè¯¦ç»†æ¢³ç†æ¯ä¸ªäº‹ä»¶ä¸­éœ€è¦ç»´æŠ¤çš„å…·ä½“å±æ€§åŠå…¶å˜æ›´è§„åˆ™ã€‚å°†å†…å­˜çŠ¶æ€å½“ä½œæ•°æ®åº“ä¸€æ ·ç»´æŠ¤ï¼Œç¡®ä¿æ¯ä¸ªå±æ€§çš„å˜æ›´éƒ½æœ‰æ˜ç¡®çš„é€»è¾‘ã€‚

**æ³¨æ„ï¼š** æ–‡æ¡£ä¸­æ‰€æœ‰æ“ä½œéƒ½éœ€è¦ç¬¦åˆä¸Šè¿°æ ¸å¿ƒåŸåˆ™ï¼Œä¸ç¬¦åˆçš„æ“ä½œå·²æ ‡æ³¨ä¸º"âŒ éœ€è¦ä¿®æ”¹"ã€‚

## ä¸€ã€çŠ¶æ€å±æ€§å®šä¹‰

### 1.1 è§’è‰²å¯¹è±¡å±æ€§ï¼ˆRole/UserRoleï¼‰

#### 1.1.1 æ•°æ®åº“æŒä¹…åŒ–å±æ€§ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
- `id: number` - è§’è‰²IDï¼ˆä¸»é”®ï¼‰
- `name?: string` - è§’è‰²åç§°
- `user: string` - userå­—æ®µï¼ˆä¼™ä¼´è§’è‰²ï¼‰æˆ– `apiKey: string`ï¼ˆç”¨æˆ·è§’è‰²ï¼‰#è¿™ä»–å¦ˆä¸å¯¹å•Šï¼Œç”¨æˆ·ä¹Ÿæœ‰å¤šè§’è‰²å•Šï¼Œæ€ä¹ˆæçš„ï¼Œæ•´ç€æ•´ç€å°±ä»–å¦ˆå…¨å˜å‘³äº†ï¼Ÿï¼è§’è‰²é™¤äº†ç±»å‹ï¼Œåœ¨å¯¹è±¡çº§åˆ«æ˜¯ä¸€è‡´çš„ï¼
- `type: 'digital_human' | 'illustration'` - è§’è‰²ç±»å‹
- `description?: string` - è§’è‰²æè¿°ï¼ˆä»…ä¼™ä¼´è§’è‰²ï¼‰
- `avatar?: string` - å¤´åƒURL
- `positionX?: number` - æ°´å¹³ä½ç½®ç™¾åˆ†æ¯”
- `positionY?: number` - å‚ç›´ä½ç½®ç™¾åˆ†æ¯”
- `scale?: number` - ç¼©æ”¾æ¯”ä¾‹
- `baseURL?: string` - å¤§æ¨¡å‹API Base URL
- `model?: string` - å¤§æ¨¡å‹åç§°
- `apiKey?: string` - å¤§æ¨¡å‹API Keyï¼ˆä»…ä¼™ä¼´è§’è‰²ï¼‰#ç”¨æˆ·è§’è‰²ä¹Ÿè¦å¡«å†™æ­¤å­—æ®µï¼è°ƒç”¨å¤§æ¨¡å‹æ—¶ç»Ÿä¸€ä½¿ç”¨æ­¤å­—æ®µ
- `avatarAppId?: string` - æ•°å­—äºº SDK App ID
- `avatarAppSecret?: string` - æ•°å­—äºº SDK App Secret
- `isCurrent: boolean` - æ˜¯å¦ä¸ºå½“å‰è§’è‰²ï¼ˆä»…ç”¨æˆ·è§’è‰²ï¼‰
- `createdAt: number` - åˆ›å»ºæ—¶é—´æˆ³
- `updatedAt: number` - æ›´æ–°æ—¶é—´æˆ³

#### 1.1.2 å†…å­˜çŠ¶æ€å±æ€§ï¼ˆä¸å­˜å‚¨åˆ°æ•°æ®åº“ï¼‰
- `isConnecting?: boolean` - æ˜¯å¦æ­£åœ¨è¿æ¥æ•°å­—äººSDK
- `isConnected?: boolean` - æ˜¯å¦å·²è¿æ¥æ•°å­—äººSDK
- `showDigitalHuman?: boolean` - æ˜¯å¦æ˜¾ç¤ºæ•°å­—äººå®¹å™¨
- `digitalHumanInstance?: DigitalHumanInstance | null` - æ•°å­—äººSDKå®ä¾‹å¼•ç”¨

### 1.2 æ¸²æŸ“å™¨ç®¡ç†å™¨çŠ¶æ€ï¼ˆrendererManagerï¼‰

#### 1.2.1 å†…éƒ¨çŠ¶æ€
- `renderers: Map<string, IRenderer>` - æ¸²æŸ“å™¨å®ä¾‹Map
  - Keyæ ¼å¼ï¼š
    - ç”¨æˆ·è§’è‰²ï¼š`user:${role.id}` # ä¸å¯¹ï¼Œå’Œä¼™ä¼´è§’è‰²ä¸€è‡´ï¼Œä¸è¦æä¸¤å¥—é€»è¾‘å‡ºæ¥ï¼
    - ä¼™ä¼´è§’è‰²ï¼š`partner:${role.user}`
  - Valueï¼š`IRenderer` å®ä¾‹ï¼ˆé€šå¸¸æ˜¯ `DigitalHumanRenderer`ï¼‰

#### 1.2.2 æ“ä½œæ–¹æ³•
- `getRenderer(roleId: string): IRenderer | null` - è·å–æ¸²æŸ“å™¨
- `createRenderer(roleId: string, config: IRendererConfig): Promise<IRenderer>` - åˆ›å»ºæ¸²æŸ“å™¨
- `destroyRenderer(roleId: string): void` - é”€æ¯æ¸²æŸ“å™¨

### 1.3 å…¨å±€çŠ¶æ€ï¼ˆappStateï¼‰

#### 1.3.1 å½“å‰è§’è‰²å¼•ç”¨
- `appState.currentUserRole: UserRole | null` - å½“å‰ç”¨æˆ·è§’è‰²å¯¹è±¡å¼•ç”¨
- `appState.currentPartnerRole: Role | null` - å½“å‰ä¼™ä¼´è§’è‰²å¯¹è±¡å¼•ç”¨

#### 1.3.2 è§’è‰²åˆ—è¡¨
- `userRoles: UserRole[]` - ç”¨æˆ·è§’è‰²åˆ—è¡¨ï¼ˆrefï¼‰
- `roles: Role[]` - ä¼™ä¼´è§’è‰²åˆ—è¡¨ï¼ˆrefï¼‰

## äºŒã€å±æ€§å˜æ›´è§„åˆ™

### 2.1 æ•°å­—äººçŠ¶æ€å±æ€§çš„ä¾èµ–å…³ç³»

```
isConnecting (è¿æ¥ä¸­)
  â†“ (è¿æ¥æˆåŠŸ)
isConnected = true
digitalHumanInstance = instance
showDigitalHuman = true (å¯é€‰ï¼Œå–å†³äºæ˜¯å¦ç«‹å³æ˜¾ç¤º)

isConnected = true
  â†“ (æ–­å¼€è¿æ¥)
isConnected = false
digitalHumanInstance = null
showDigitalHuman = false (å¯é€‰ï¼Œå–å†³äºæ˜¯å¦ç«‹å³éšè—)
```

### 2.2 å±æ€§åˆå§‹åŒ–è§„åˆ™

#### 2.2.1 ä»æ•°æ®åº“åŠ è½½è§’è‰²æ—¶
```typescript
// æ‰€æœ‰å†…å­˜çŠ¶æ€å±æ€§åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼
role.isConnecting = false
role.isConnected = false
role.showDigitalHuman = false
role.digitalHumanInstance = null

// ç„¶åæ£€æŸ¥ rendererManager æ˜¯å¦å­˜åœ¨æ¸²æŸ“å™¨
const roleId = getRoleId(role)
const renderer = rendererManager.getRenderer(roleId)
if (renderer) {
  // æ¢å¤è¿æ¥çŠ¶æ€
  role.isConnected = true
  role.showDigitalHuman = true
  if (renderer instanceof DigitalHumanRenderer) {
    role.digitalHumanInstance = renderer.getInstance()
  }
}
```

#### 2.2.2 åˆ›å»ºæ–°è§’è‰²æ—¶
```typescript
// æ‰€æœ‰å†…å­˜çŠ¶æ€å±æ€§åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼
newRole.isConnecting = false
newRole.isConnected = false
newRole.showDigitalHuman = false
newRole.digitalHumanInstance = null
```

### 2.3 å±æ€§æ¸…ç†è§„åˆ™

#### 2.3.1 å¤±æ´»è§’è‰²æ—¶
```typescript
// å¦‚æœè§’è‰²æ˜¯æ•°å­—äººç±»å‹ä¸”å·²è¿æ¥
if (role.type === 'digital_human' && role.isConnected) {
  // æ–­å¼€è¿æ¥
  const renderer = rendererManager.getRenderer(roleId)
  if (renderer) {
    await renderer.disconnect()
    rendererManager.destroyRenderer(roleId)
  }
  
  // æ¸…ç†å±æ€§
  role.isConnected = false
  role.showDigitalHuman = false
  role.digitalHumanInstance = null
  role.isConnecting = false
}
```

#### 2.3.2 åˆ é™¤è§’è‰²æ—¶
```typescript
// å…ˆæ¸…ç†çŠ¶æ€ï¼ˆå¦‚æœå·²è¿æ¥ï¼‰
if (role.isConnected) {
  const renderer = rendererManager.getRenderer(roleId)
  if (renderer) {
    await renderer.disconnect()
    rendererManager.destroyRenderer(roleId)
  }
}

// æ¸…ç†å±æ€§ï¼ˆå¦‚æœå¯¹è±¡è¿˜å­˜åœ¨ï¼‰
role.isConnected = false
role.showDigitalHuman = false
role.digitalHumanInstance = null
role.isConnecting = false
```

## ä¸‰ã€äº‹ä»¶çº§åˆ«çš„å±æ€§å˜æ›´æ¸…å•

**å®ç°çŠ¶æ€è¯´æ˜ï¼š**
- âœ… **å·²å®Œæˆ**ï¼šä»£ç å·²æŒ‰æ–‡æ¡£å®ç°
- ğŸ”„ **è¿›è¡Œä¸­**ï¼šä»£ç æ­£åœ¨ä¿®æ”¹ä¸­
- âŒ **æœªå®ç°**ï¼šä»£ç å°šæœªæŒ‰æ–‡æ¡£å®ç°
- âš ï¸ **éœ€æ£€æŸ¥**ï¼šéœ€è¦æ£€æŸ¥ä»£ç æ˜¯å¦ç¬¦åˆæ–‡æ¡£

### 3.1 ç”¨æˆ·ç™»å½•ï¼ˆhandleLoginï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·è¾“å…¥ API Key ç™»å½•

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `userRoles` | - | èµ‹å€¼ | `await getUserRoles(apiKey)` | ä»æ•°æ®åº“åŠ è½½ |
| `appState.currentUserRole` | - | èµ‹å€¼ | `roleList.find(r => r.isCurrent)` | è®¾ç½®ä¸ºå½“å‰è§’è‰² |
| `userRoles[]` | `isConnecting` | åˆå§‹åŒ– | `false` | æ¯ä¸ªè§’è‰² |
| `userRoles[]` | `isConnected` | åˆå§‹åŒ– | `false` | æ¯ä¸ªè§’è‰² |
| `userRoles[]` | `showDigitalHuman` | åˆå§‹åŒ– | `false` | æ¯ä¸ªè§’è‰² |
| `userRoles[]` | `digitalHumanInstance` | åˆå§‹åŒ– | `null` | æ¯ä¸ªè§’è‰² |
| `userRoles[]` | `isConnected` | æ¢å¤ | `true` | âœ… **å·²å®Œæˆ**ï¼šå¦‚æœ rendererManager ä¸­å­˜åœ¨æ¸²æŸ“å™¨ |
| `userRoles[]` | `showDigitalHuman` | æ¢å¤ | `true` | âœ… **å·²å®Œæˆ**ï¼šå¦‚æœ rendererManager ä¸­å­˜åœ¨æ¸²æŸ“å™¨ |
| `userRoles[]` | `digitalHumanInstance` | æ¢å¤ | `renderer.getInstance()` | âœ… **å·²å®Œæˆ**ï¼šå¦‚æœ rendererManager ä¸­å­˜åœ¨æ¸²æŸ“å™¨ |
| `appState.currentUserRole` | - | æ¿€æ´» | è°ƒç”¨ `activateUserRole()` | å¦‚æœå­˜åœ¨å½“å‰è§’è‰² |
| `appState.currentUserRole` | `showDigitalHuman` | è®¾ç½® | `true` | å¦‚æœæ˜¯æ•°å­—äººç±»å‹ï¼ˆæ¿€æ´»æ—¶ï¼‰ |

### 3.2 ç”¨æˆ·é€€å‡ºï¼ˆhandleLogoutï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·ç‚¹å‡»é€€å‡ºç™»å½•

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `userRoles` | - | æ¸…ç©º | `[]` | æ¸…ç©ºæ•°ç»„ |
| `roles` | - | æ¸…ç©º | `[]` | æ¸…ç©ºæ•°ç»„ |
| `appState.currentUserRole` | - | æ¸…ç©º | `null` | æ¸…ç©ºå¼•ç”¨ |
| `appState.currentPartnerRole` | - | æ¸…ç©º | `null` | æ¸…ç©ºå¼•ç”¨ |
| `rendererManager` | `renderers` | é”€æ¯ | åˆ é™¤æ‰€æœ‰ `user:*` å’Œ `partner:*` æ¸²æŸ“å™¨ | éå†é”€æ¯ |
| `appState.chatHistory` | - | æ¸…ç©º | `[]` | æ¸…ç©ºå¯¹è¯å†å² |
| `appState.llm.apiKey` | - | æ¸…ç©º | `''` | æ¸…ç©ºAPI Key |
| `appState.llm.user` | - | æ¸…ç©º | `''` | æ¸…ç©ºuserå­—æ®µ |

**æ³¨æ„ï¼š** åœ¨æ¸…ç©ºæ•°ç»„å’Œå¼•ç”¨ä¹‹å‰ï¼Œéœ€è¦å…ˆå¤±æ´»å½“å‰è§’è‰²å¹¶æ¸…ç†çŠ¶æ€ã€‚

### 3.3 åˆ›å»ºç”¨æˆ·è§’è‰²ï¼ˆhandleSaveUserRole - æ–°å»ºï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨ç¼–è¾‘è¡¨å•ä¸­åˆ›å»ºæ–°è§’è‰²

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| æ•°æ®åº“ | - | INSERT | æ–°è®°å½• | æ•°æ®åº“æ“ä½œ |
| âŒ `userRoles` | - | ~~é‡æ–°åŠ è½½~~ | ~~`await loadUserRoles()`~~ | âŒ **éœ€è¦ä¿®æ”¹**ï¼šåº”è¯¥åªæ·»åŠ æ–°è§’è‰²ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² |
| âœ… `userRoles` | - | æ·»åŠ  | `userRoles.value.push(newRole)` | âœ… **æ­£ç¡®**ï¼šåªæ·»åŠ æ–°åˆ›å»ºçš„è§’è‰² |
| `userRoles[]` (æ–°è§’è‰²) | `isConnecting` | åˆå§‹åŒ– | `false` | æ–°è§’è‰² |
| `userRoles[]` (æ–°è§’è‰²) | `isConnected` | åˆå§‹åŒ– | `false` | æ–°è§’è‰² |
| `userRoles[]` (æ–°è§’è‰²) | `showDigitalHuman` | åˆå§‹åŒ– | `false` | æ–°è§’è‰² |
| `userRoles[]` (æ–°è§’è‰²) | `digitalHumanInstance` | åˆå§‹åŒ– | `null` | æ–°è§’è‰² |
| `appState.currentUserRole` | - | è®¾ç½® | æ–°è§’è‰² | å¦‚æœä¹‹å‰ä¸ºç©º |
| `appState.currentUserRole` | `showDigitalHuman` | è®¾ç½® | `true` | å¦‚æœæ˜¯æ•°å­—äººç±»å‹ï¼ˆæ¿€æ´»æ—¶ï¼‰ |

### 3.4 æ›´æ–°ç”¨æˆ·è§’è‰²ï¼ˆhandleSaveUserRole - ç¼–è¾‘ï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨ç¼–è¾‘è¡¨å•ä¸­æ›´æ–°è§’è‰²

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| æ•°æ®åº“ | - | UPDATE | æ›´æ–°è®°å½• | æ•°æ®åº“æ“ä½œ |
| âŒ `userRoles` | - | ~~é‡æ–°åŠ è½½~~ | ~~`await loadUserRoles()`~~ | âŒ **éœ€è¦ä¿®æ”¹**ï¼šåº”è¯¥åªæ›´æ–°é‚£ä¸ªè§’è‰²çš„å±æ€§ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² |
| âœ… `userRoles[]` (æ›´æ–°è§’è‰²) | æ‰€æœ‰æ•°æ®åº“å±æ€§ | æ›´æ–° | ä»APIè¿”å›çš„æ›´æ–°å€¼ | âœ… **æ­£ç¡®**ï¼šåªæ›´æ–°é‚£ä¸ªè§’è‰²çš„æ•°æ®åº“å±æ€§ |
| `userRoles[]` (æ›´æ–°è§’è‰²) | `isConnecting` | ä¿æŒ | ä¿æŒåŸå€¼ | å¦‚æœç±»å‹æœªå˜æ›´ |
| `userRoles[]` (æ›´æ–°è§’è‰²) | `isConnected` | æ£€æŸ¥/æ¸…ç† | å¦‚æœç±»å‹å˜æ›´åˆ™ `false`ï¼Œå¦åˆ™ä¿æŒ | ç±»å‹å˜æ›´æ£€æŸ¥ |
| `userRoles[]` (æ›´æ–°è§’è‰²) | `showDigitalHuman` | æ£€æŸ¥/æ¸…ç† | å¦‚æœç±»å‹å˜æ›´åˆ™ `false`ï¼Œå¦åˆ™ä¿æŒ | ç±»å‹å˜æ›´æ£€æŸ¥ |
| `userRoles[]` (æ›´æ–°è§’è‰²) | `digitalHumanInstance` | æ£€æŸ¥/æ¸…ç† | å¦‚æœç±»å‹å˜æ›´åˆ™ `null`ï¼Œå¦åˆ™ä¿æŒ | ç±»å‹å˜æ›´æ£€æŸ¥ |
| `rendererManager` | `renderers[userRoleId]` | é”€æ¯ | åˆ é™¤æ¸²æŸ“å™¨ | å¦‚æœç±»å‹ä»æ•°å­—äººæ”¹ä¸ºç«‹ç»˜ |
| `appState.currentUserRole` | - | æ›´æ–°å±æ€§ | æ›´æ–°ç°æœ‰å¯¹è±¡çš„å±æ€§ | å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰è§’è‰²ï¼ˆä¿æŒå¼•ç”¨ä¸å˜ï¼‰ |

**ç±»å‹å˜æ›´æ£€æŸ¥é€»è¾‘ï¼š**
```typescript
const oldRole = userRoles.value.find(r => r.id === editingRole.id)
const typeChanged = oldRole?.type !== roleForm.value.type

if (typeChanged) {
  if (oldRole?.type === 'digital_human') {
    // ä»æ•°å­—äººæ”¹ä¸ºç«‹ç»˜ï¼šæ¸…ç†æ•°å­—äººçŠ¶æ€
    const roleId = `user:${oldRole.id}`
    const renderer = rendererManager.getRenderer(roleId)
    if (renderer) {
      await renderer.disconnect()
      rendererManager.destroyRenderer(roleId)
    }
    // æ¸…ç†å±æ€§ï¼ˆåœ¨é‡æ–°åŠ è½½åï¼Œè¿™äº›å±æ€§ä¼šè¢«åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ï¼‰
  } else if (roleForm.value.type === 'digital_human') {
    // ä»ç«‹ç»˜æ”¹ä¸ºæ•°å­—äººï¼šåˆå§‹åŒ–æ•°å­—äººå±æ€§ï¼ˆåœ¨ loadUserRoles ä¸­å¤„ç†ï¼‰
  }
}
```

### 3.5 åˆ é™¤ç”¨æˆ·è§’è‰²ï¼ˆhandleDeleteUserRoleï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨è§’è‰²åˆ—è¡¨ä¸­åˆ é™¤è§’è‰²

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| æ•°æ®åº“ | - | DELETE | åˆ é™¤è®°å½• | æ•°æ®åº“æ“ä½œ |
| `rendererManager` | `renderers[userRoleId]` | é”€æ¯ | åˆ é™¤æ¸²æŸ“å™¨ | å¦‚æœè§’è‰²å·²è¿æ¥ |
| `rendererManager` | `renderers[userRoleId]` | æ–­å¼€ | `renderer.disconnect()` | å¦‚æœè§’è‰²å·²è¿æ¥ |
| âŒ `userRoles` | - | ~~é‡æ–°åŠ è½½~~ | ~~`await loadUserRoles()`~~ | âŒ **éœ€è¦ä¿®æ”¹**ï¼šåº”è¯¥åªä»åˆ—è¡¨ä¸­ç§»é™¤é‚£ä¸ªè§’è‰²ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² |
| âœ… `userRoles` | - | ç§»é™¤ | `userRoles.value = userRoles.value.filter(r => r.id !== role.id)` | âœ… **æ­£ç¡®**ï¼šåªç§»é™¤è¢«åˆ é™¤çš„è§’è‰² |
| `appState.currentUserRole` | - | æ¸…ç©º/ä¿æŒ | `null` æˆ–è‡ªåŠ¨é€‰æ‹©å…¶ä»–è§’è‰² | å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è§’è‰² |

**åˆ é™¤å‰æ¸…ç†é€»è¾‘ï¼š**
```typescript
const userRoleId = `user:${role.id}`
const renderer = rendererManager.getRenderer(userRoleId)

if (renderer) {
  // æ–­å¼€è¿æ¥
  await renderer.disconnect()
  // é”€æ¯æ¸²æŸ“å™¨
  rendererManager.destroyRenderer(userRoleId)
}

// å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è§’è‰²ï¼Œå…ˆå¤±æ´»
if (appState.currentUserRole?.id === role.id) {
  await deactivateUserRole(role)
  appState.currentUserRole = null
}
```

### 3.6 è®¾ç½®å½“å‰ç”¨æˆ·è§’è‰²ï¼ˆhandleSetCurrentUserRoleï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨è§’è‰²åˆ—è¡¨ä¸­ç‚¹å‡»"è®¾ä¸ºå½“å‰"

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| æ•°æ®åº“ | `is_current` | UPDATE | `1` ä¸ºæ–°è§’è‰²ï¼Œ`0` ä¸ºå…¶ä»–è§’è‰² | æ•°æ®åº“æ“ä½œ |
| âŒ `userRoles` | - | ~~é‡æ–°åŠ è½½~~ | ~~`await loadUserRoles()`~~ | âŒ **éœ€è¦ä¿®æ”¹**ï¼šåº”è¯¥åªæ›´æ–° `isCurrent` å±æ€§ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² |
| âœ… `userRoles[]` (æ—§è§’è‰²) | `isCurrent` | æ›´æ–° | `false` | âœ… **æ­£ç¡®**ï¼šåªæ›´æ–°æ—§è§’è‰²çš„ `isCurrent` å±æ€§ |
| âœ… `userRoles[]` (æ–°è§’è‰²) | `isCurrent` | æ›´æ–° | `true` | âœ… **æ­£ç¡®**ï¼šåªæ›´æ–°æ–°è§’è‰²çš„ `isCurrent` å±æ€§ |
| `appState.currentUserRole` (æ—§) | `isConnected` | æ¸…ç† | `false` | å¦‚æœå·²è¿æ¥ |
| `appState.currentUserRole` (æ—§) | `showDigitalHuman` | æ¸…ç† | `false` | å¦‚æœå·²è¿æ¥ |
| `appState.currentUserRole` (æ—§) | `digitalHumanInstance` | æ¸…ç† | `null` | å¦‚æœå·²è¿æ¥ |
| `rendererManager` | `renderers[oldUserRoleId]` | é”€æ¯ | åˆ é™¤æ¸²æŸ“å™¨ | å¦‚æœæ—§è§’è‰²å·²è¿æ¥ |
| `appState.currentUserRole` | - | æ›´æ–°å¼•ç”¨ | æ–°è§’è‰²å¯¹è±¡ | æ›´æ–°å¼•ç”¨ï¼ˆæŒ‡å‘åˆ—è¡¨ä¸­çš„å¯¹è±¡ï¼‰ |
| `appState.currentUserRole` (æ–°) | `showDigitalHuman` | è®¾ç½® | `true` | å¦‚æœæ˜¯æ•°å­—äººç±»å‹ï¼ˆæ¿€æ´»æ—¶ï¼‰ |

### 3.7 è¿æ¥ç”¨æˆ·è§’è‰²æ•°å­—äººï¼ˆhandleConnectUserRoleFromListï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨è§’è‰²åˆ—è¡¨ä¸­ç‚¹å‡»"è¿æ¥"æŒ‰é’®

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `role` | `isConnecting` | è®¾ç½® | `true` | å¼€å§‹è¿æ¥ |
| `role` | `showDigitalHuman` | è®¾ç½® | `true` | æ˜¾ç¤ºå®¹å™¨ |
| `rendererManager` | `renderers[userRoleId]` | åˆ›å»º/è·å– | `createRenderer()` æˆ– `getRenderer()` | å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º |
| `rendererManager` | `renderers[userRoleId]` | è°ƒç”¨ | `renderer.render(containerElement)` | è®¾ç½®å®¹å™¨ |
| `rendererManager` | `renderers[userRoleId]` | è°ƒç”¨ | `renderer.connect()` | è¿æ¥SDK |
| `role` | `digitalHumanInstance` | è®¾ç½® | `renderer.getInstance()` | ä¿å­˜å®ä¾‹å¼•ç”¨ |
| `role` | `isConnected` | è®¾ç½® | `true` | è¿æ¥æˆåŠŸ |
| `role` | `isConnecting` | è®¾ç½® | `false` | è¿æ¥å®Œæˆ |

**é”™è¯¯å¤„ç†ï¼š**
- å¦‚æœè¿æ¥å¤±è´¥ï¼Œéœ€è¦å›æ»šçŠ¶æ€ï¼š
  - `role.isConnecting = false`
  - `role.showDigitalHuman = false`

### 3.8 æ–­å¼€ç”¨æˆ·è§’è‰²æ•°å­—äººï¼ˆhandleDisconnectUserRoleFromListï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨è§’è‰²åˆ—è¡¨ä¸­ç‚¹å‡»"æ–­å¼€"æŒ‰é’®

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `rendererManager` | `renderers[userRoleId]` | è°ƒç”¨ | `renderer.disconnect()` | æ–­å¼€è¿æ¥ |
| `rendererManager` | `renderers[userRoleId]` | è°ƒç”¨ | `renderer.hide()` | éšè—æ•°å­—äºº |
| `rendererManager` | `renderers[userRoleId]` | é”€æ¯/ä¿ç•™ | `destroyRenderer()` æˆ–ä¿ç•™ | å¯é€‰æ“ä½œ |
| `role` | `showDigitalHuman` | è®¾ç½® | `false` | éšè—å®¹å™¨ |
| `role` | `digitalHumanInstance` | è®¾ç½® | `null` | æ¸…ç©ºå®ä¾‹å¼•ç”¨ |
| `role` | `isConnected` | è®¾ç½® | `false` | æ–­å¼€è¿æ¥ |
| `role` | `isConnecting` | è®¾ç½® | `false` | ç¡®ä¿ä¸æ˜¯è¿æ¥ä¸­çŠ¶æ€ |

### 3.9 åˆ‡æ¢ç”¨æˆ·æ•°å­—äººæ˜¾ç¤º/éšè—ï¼ˆtoggleIllustration - ç”¨æˆ·æ•°å­—äººï¼‰

**å®ç°çŠ¶æ€ï¼š** âš ï¸ **éœ€æ£€æŸ¥**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢æŒ‰é’®

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `appState.currentUserRole` | `showDigitalHuman` | åˆ‡æ¢ | `!role.showDigitalHuman` | åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€ |

**å‰ç½®æ¡ä»¶ï¼š**
- `role.isConnected === true`ï¼ˆå·²è¿æ¥ï¼‰
- `rendererManager.getRenderer(userRoleId)` å­˜åœ¨

### 3.10 åˆ›å»ºä¼™ä¼´è§’è‰²ï¼ˆhandleSaveRole - æ–°å»ºï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨ç¼–è¾‘è¡¨å•ä¸­åˆ›å»ºæ–°è§’è‰²

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| æ•°æ®åº“ | - | INSERT | æ–°è®°å½• | æ•°æ®åº“æ“ä½œ |
| âŒ `roles` | - | ~~é‡æ–°åŠ è½½~~ | ~~`await loadRoles()`~~ | âŒ **éœ€è¦ä¿®æ”¹**ï¼šåº”è¯¥åªæ·»åŠ æ–°è§’è‰²ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² |
| âœ… `roles` | - | æ·»åŠ  | `roles.value.push(newRole)` | âœ… **æ­£ç¡®**ï¼šåªæ·»åŠ æ–°åˆ›å»ºçš„è§’è‰² |
| `roles[]` (æ–°è§’è‰²) | `isConnecting` | åˆå§‹åŒ– | `false` | æ–°è§’è‰² |
| `roles[]` (æ–°è§’è‰²) | `isConnected` | åˆå§‹åŒ– | `false` | æ–°è§’è‰² |
| `roles[]` (æ–°è§’è‰²) | `showDigitalHuman` | åˆå§‹åŒ– | `false` | æ–°è§’è‰² |
| `roles[]` (æ–°è§’è‰²) | `digitalHumanInstance` | åˆå§‹åŒ– | `null` | æ–°è§’è‰² |

### 3.11 æ›´æ–°ä¼™ä¼´è§’è‰²ï¼ˆhandleSaveRole - ç¼–è¾‘ï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨ç¼–è¾‘è¡¨å•ä¸­æ›´æ–°è§’è‰²

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| æ•°æ®åº“ | - | UPDATE | æ›´æ–°è®°å½• | æ•°æ®åº“æ“ä½œ |
| âŒ `roles` | - | ~~é‡æ–°åŠ è½½~~ | ~~`await loadRoles()`~~ | âŒ **éœ€è¦ä¿®æ”¹**ï¼šåº”è¯¥åªæ›´æ–°é‚£ä¸ªè§’è‰²çš„å±æ€§ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² |
| âœ… `roles[]` (æ›´æ–°è§’è‰²) | æ‰€æœ‰æ•°æ®åº“å±æ€§ | æ›´æ–° | ä»APIè¿”å›çš„æ›´æ–°å€¼ | âœ… **æ­£ç¡®**ï¼šåªæ›´æ–°é‚£ä¸ªè§’è‰²çš„æ•°æ®åº“å±æ€§ |
| `roles[]` (æ›´æ–°è§’è‰²) | `isConnecting` | ä¿æŒ | ä¿æŒåŸå€¼ | å¦‚æœç±»å‹æœªå˜æ›´ |
| `roles[]` (æ›´æ–°è§’è‰²) | `isConnected` | æ£€æŸ¥/æ¸…ç† | å¦‚æœç±»å‹å˜æ›´åˆ™ `false`ï¼Œå¦åˆ™ä¿æŒ | ç±»å‹å˜æ›´æ£€æŸ¥ |
| `roles[]` (æ›´æ–°è§’è‰²) | `showDigitalHuman` | æ£€æŸ¥/æ¸…ç† | å¦‚æœç±»å‹å˜æ›´åˆ™ `false`ï¼Œå¦åˆ™ä¿æŒ | ç±»å‹å˜æ›´æ£€æŸ¥ |
| `roles[]` (æ›´æ–°è§’è‰²) | `digitalHumanInstance` | æ£€æŸ¥/æ¸…ç† | å¦‚æœç±»å‹å˜æ›´åˆ™ `null`ï¼Œå¦åˆ™ä¿æŒ | ç±»å‹å˜æ›´æ£€æŸ¥ |
| `rendererManager` | `renderers[partnerRoleId]` | é”€æ¯ | åˆ é™¤æ¸²æŸ“å™¨ | å¦‚æœç±»å‹ä»æ•°å­—äººæ”¹ä¸ºç«‹ç»˜ |
| `appState.currentPartnerRole` | - | æ›´æ–°å±æ€§ | æ›´æ–°ç°æœ‰å¯¹è±¡çš„å±æ€§ | å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰è§’è‰²ï¼ˆä¿æŒå¼•ç”¨ä¸å˜ï¼‰ |

### 3.12 åˆ é™¤ä¼™ä¼´è§’è‰²ï¼ˆhandleDeleteRoleï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨è§’è‰²åˆ—è¡¨ä¸­åˆ é™¤è§’è‰²

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| æ•°æ®åº“ | - | DELETE | åˆ é™¤è®°å½• | æ•°æ®åº“æ“ä½œ |
| `rendererManager` | `renderers[partnerRoleId]` | é”€æ¯ | åˆ é™¤æ¸²æŸ“å™¨ | å¦‚æœè§’è‰²å·²è¿æ¥ |
| `rendererManager` | `renderers[partnerRoleId]` | æ–­å¼€ | `renderer.disconnect()` | å¦‚æœè§’è‰²å·²è¿æ¥ |
| âŒ `roles` | - | ~~é‡æ–°åŠ è½½~~ | ~~`await loadRoles()`~~ | âŒ **éœ€è¦ä¿®æ”¹**ï¼šåº”è¯¥åªä»åˆ—è¡¨ä¸­ç§»é™¤é‚£ä¸ªè§’è‰²ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² |
| âœ… `roles` | - | ç§»é™¤ | `roles.value = roles.value.filter(r => r.id !== role.id)` | âœ… **æ­£ç¡®**ï¼šåªç§»é™¤è¢«åˆ é™¤çš„è§’è‰² |
| `appState.currentPartnerRole` | - | æ¸…ç©º/ä¿æŒ | `null` æˆ–è‡ªåŠ¨é€‰æ‹©å…¶ä»–è§’è‰² | å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è§’è‰² |
| `appState.llm.user` | - | æ¸…ç©º | `''` | å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è§’è‰² |

### 3.13 è®¾ç½®å½“å‰ä¼™ä¼´è§’è‰²ï¼ˆhandleSetCurrentRoleï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨è§’è‰²åˆ—è¡¨ä¸­ç‚¹å‡»"è®¾ä¸ºå½“å‰"

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `appState.llm.user` | - | è®¾ç½® | `role.user` | è®¾ç½®userå­—æ®µ |
| âŒ `roles` | - | ~~é‡æ–°åŠ è½½~~ | ~~`await loadRoles()`~~ | âŒ **éœ€è¦ä¿®æ”¹**ï¼šä¼™ä¼´è§’è‰²æ²¡æœ‰ `isCurrent` å­—æ®µï¼Œä¸éœ€è¦æ›´æ–°æ•°æ®åº“ï¼Œä¹Ÿä¸éœ€è¦é‡æ–°åŠ è½½ |
| `appState.currentPartnerRole` (æ—§) | `isConnected` | æ¸…ç† | `false` | å¦‚æœå·²è¿æ¥ |
| `appState.currentPartnerRole` (æ—§) | `showDigitalHuman` | æ¸…ç† | `false` | å¦‚æœå·²è¿æ¥ |
| `appState.currentPartnerRole` (æ—§) | `digitalHumanInstance` | æ¸…ç† | `null` | å¦‚æœå·²è¿æ¥ |
| `rendererManager` | `renderers[oldPartnerRoleId]` | é”€æ¯ | åˆ é™¤æ¸²æŸ“å™¨ | å¦‚æœæ—§è§’è‰²å·²è¿æ¥ |
| `appState.currentPartnerRole` | - | æ›´æ–°å¼•ç”¨ | æ–°è§’è‰²å¯¹è±¡ | æ›´æ–°å¼•ç”¨ï¼ˆæŒ‡å‘åˆ—è¡¨ä¸­çš„å¯¹è±¡ï¼‰ |
| `appState.currentPartnerRole` (æ–°) | `showDigitalHuman` | è®¾ç½® | `true` | å¦‚æœæ˜¯æ•°å­—äººç±»å‹ï¼ˆæ¿€æ´»æ—¶ï¼‰ |

### 3.14 è¿æ¥ä¼™ä¼´è§’è‰²æ•°å­—äººï¼ˆhandleConnectRoleFromListï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨è§’è‰²åˆ—è¡¨ä¸­ç‚¹å‡»"è¿æ¥"æŒ‰é’®

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `role` | `isConnecting` | è®¾ç½® | `true` | å¼€å§‹è¿æ¥ |
| `role` | `showDigitalHuman` | è®¾ç½® | `true` | æ˜¾ç¤ºå®¹å™¨ |
| `rendererManager` | `renderers[partnerRoleId]` | åˆ›å»º/è·å– | `createRenderer()` æˆ– `getRenderer()` | å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º |
| `rendererManager` | `renderers[partnerRoleId]` | è°ƒç”¨ | `renderer.render(containerElement)` | è®¾ç½®å®¹å™¨ |
| `rendererManager` | `renderers[partnerRoleId]` | è°ƒç”¨ | `renderer.connect()` | è¿æ¥SDK |
| `role` | `digitalHumanInstance` | è®¾ç½® | `renderer.getInstance()` | ä¿å­˜å®ä¾‹å¼•ç”¨ |
| `role` | `isConnected` | è®¾ç½® | `true` | è¿æ¥æˆåŠŸ |
| `role` | `isConnecting` | è®¾ç½® | `false` | è¿æ¥å®Œæˆ |

### 3.15 æ–­å¼€ä¼™ä¼´è§’è‰²æ•°å­—äººï¼ˆhandleDisconnectRoleFromListï¼‰

**å®ç°çŠ¶æ€ï¼š** âœ… **å·²å®Œæˆ**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨è§’è‰²åˆ—è¡¨ä¸­ç‚¹å‡»"æ–­å¼€"æŒ‰é’®

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `rendererManager` | `renderers[partnerRoleId]` | è°ƒç”¨ | `renderer.disconnect()` | æ–­å¼€è¿æ¥ |
| `rendererManager` | `renderers[partnerRoleId]` | è°ƒç”¨ | `renderer.hide()` | éšè—æ•°å­—äºº |
| `rendererManager` | `renderers[partnerRoleId]` | é”€æ¯/ä¿ç•™ | `destroyRenderer()` æˆ–ä¿ç•™ | å¯é€‰æ“ä½œ |
| `role` | `showDigitalHuman` | è®¾ç½® | `false` | éšè—å®¹å™¨ |
| `role` | `digitalHumanInstance` | è®¾ç½® | `null` | æ¸…ç©ºå®ä¾‹å¼•ç”¨ |
| `role` | `isConnected` | è®¾ç½® | `false` | æ–­å¼€è¿æ¥ |
| `role` | `isConnecting` | è®¾ç½® | `false` | ç¡®ä¿ä¸æ˜¯è¿æ¥ä¸­çŠ¶æ€ |

### 3.16 åˆ‡æ¢ä¼™ä¼´æ•°å­—äººæ˜¾ç¤º/éšè—ï¼ˆtoggleIllustration - ä¼™ä¼´æ•°å­—äººï¼‰

**å®ç°çŠ¶æ€ï¼š** âš ï¸ **éœ€æ£€æŸ¥**

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢æŒ‰é’®

**å±æ€§å˜æ›´æ¸…å•ï¼š**

| å¯¹è±¡ | å±æ€§ | å˜æ›´æ“ä½œ | å˜æ›´å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `appState.currentPartnerRole` | `showDigitalHuman` | åˆ‡æ¢ | `!role.showDigitalHuman` | åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€ |

**å‰ç½®æ¡ä»¶ï¼š**
- `role.isConnected === true`ï¼ˆå·²è¿æ¥ï¼‰
- `rendererManager.getRenderer(partnerRoleId)` å­˜åœ¨

## å››ã€å±æ€§å˜æ›´çš„åŸå­æ€§ä¿è¯

### 4.1 è¿æ¥æ“ä½œçš„åŸå­æ€§

è¿æ¥æ“ä½œéœ€è¦ä¿è¯ä»¥ä¸‹å±æ€§çš„åŸå­æ€§å˜æ›´ï¼š
```typescript
// æ­¥éª¤1ï¼šè®¾ç½®è¿æ¥ä¸­çŠ¶æ€
role.isConnecting = true
role.showDigitalHuman = true

// æ­¥éª¤2ï¼šåˆ›å»º/è·å–æ¸²æŸ“å™¨
const renderer = await rendererManager.createRenderer(...)

// æ­¥éª¤3ï¼šè¿æ¥SDK
await renderer.render(containerElement)
await renderer.connect()

// æ­¥éª¤4ï¼šè®¾ç½®è¿æ¥æˆåŠŸçŠ¶æ€ï¼ˆåŸå­æ€§ï¼‰
role.digitalHumanInstance = renderer.getInstance()
role.isConnected = true
role.isConnecting = false
```

å¦‚æœæ­¥éª¤2æˆ–3å¤±è´¥ï¼Œéœ€è¦å›æ»šï¼š
```typescript
role.isConnecting = false
role.showDigitalHuman = false
```

### 4.2 æ–­å¼€æ“ä½œçš„åŸå­æ€§

æ–­å¼€æ“ä½œéœ€è¦ä¿è¯ä»¥ä¸‹å±æ€§çš„åŸå­æ€§å˜æ›´ï¼š
```typescript
// æ­¥éª¤1ï¼šæ–­å¼€è¿æ¥
await renderer.disconnect()
await renderer.hide()

// æ­¥éª¤2ï¼šæ¸…ç†çŠ¶æ€ï¼ˆåŸå­æ€§ï¼‰
role.showDigitalHuman = false
role.digitalHumanInstance = null
role.isConnected = false
role.isConnecting = false

// æ­¥éª¤3ï¼šé”€æ¯æ¸²æŸ“å™¨ï¼ˆå¯é€‰ï¼‰
rendererManager.destroyRenderer(roleId)
```

### 4.3 è§’è‰²åˆ‡æ¢çš„åŸå­æ€§

è§’è‰²åˆ‡æ¢éœ€è¦ä¿è¯ä»¥ä¸‹æ“ä½œçš„åŸå­æ€§ï¼š
```typescript
// æ­¥éª¤1ï¼šå¤±æ´»æ—§è§’è‰²ï¼ˆåŸå­æ€§ï¼‰
await deactivateUserRole(oldRole)
// å†…éƒ¨æ“ä½œï¼š
//   - æ–­å¼€è¿æ¥
//   - æ¸…ç†å±æ€§
//   - é”€æ¯æ¸²æŸ“å™¨

// æ­¥éª¤2ï¼šæ›´æ–°æ•°æ®åº“
await setCurrentUserRole(newRole.id, apiKey)

// æ­¥éª¤3ï¼šé‡æ–°åŠ è½½åˆ—è¡¨
await loadUserRoles()

// æ­¥éª¤4ï¼šæ›´æ–°å¼•ç”¨
appState.currentUserRole = newRole

// æ­¥éª¤5ï¼šæ¿€æ´»æ–°è§’è‰²ï¼ˆåŸå­æ€§ï¼‰
await activateUserRole(newRole)
// å†…éƒ¨æ“ä½œï¼š
//   - è®¾ç½® showDigitalHuman = trueï¼ˆå¦‚æœæ˜¯æ•°å­—äººï¼‰
```

## äº”ã€å±æ€§å˜æ›´çš„ä¾èµ–æ£€æŸ¥

### 5.1 è¿æ¥å‰çš„ä¾èµ–æ£€æŸ¥

åœ¨è¿æ¥æ•°å­—äººä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥ä»¥ä¸‹å±æ€§ï¼š
- `role.type === 'digital_human'` - å¿…é¡»æ˜¯æ•°å­—äººç±»å‹
- `role.avatarAppId` å’Œ `role.avatarAppSecret` - å¿…é¡»å·²é…ç½®
- `role.isConnected === false` - å¿…é¡»æœªè¿æ¥
- `role.isConnecting === false` - å¿…é¡»ä¸åœ¨è¿æ¥ä¸­
- `appState.currentUserRole?.id === role.id` - å¿…é¡»æ˜¯å½“å‰è§’è‰²ï¼ˆç”¨æˆ·è§’è‰²ï¼‰

### 5.2 æ–­å¼€å‰çš„ä¾èµ–æ£€æŸ¥

åœ¨æ–­å¼€æ•°å­—äººä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥ä»¥ä¸‹å±æ€§ï¼š
- `role.isConnected === true` - å¿…é¡»å·²è¿æ¥
- `rendererManager.getRenderer(roleId)` - æ¸²æŸ“å™¨å¿…é¡»å­˜åœ¨

### 5.3 åˆ‡æ¢æ˜¾ç¤ºå‰çš„ä¾èµ–æ£€æŸ¥

åœ¨åˆ‡æ¢æ˜¾ç¤ºä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥ä»¥ä¸‹å±æ€§ï¼š
- `role.isConnected === true` - å¿…é¡»å·²è¿æ¥
- `rendererManager.getRenderer(roleId)` - æ¸²æŸ“å™¨å¿…é¡»å­˜åœ¨

## å…­ã€å±æ€§å˜æ›´çš„å®ç°æ¨¡å¼

### 6.1 çŠ¶æ€æ¢å¤æ¨¡å¼ï¼ˆloadUserRoles / loadRolesï¼‰

```typescript
async function loadUserRoles() {
  // 1. ä»æ•°æ®åº“åŠ è½½
  const roleList = await getUserRoles(globalApiKey.value)
  
  // 2. åˆå§‹åŒ–æ‰€æœ‰å†…å­˜çŠ¶æ€å±æ€§
  roleList.forEach(role => {
    // åˆå§‹åŒ–é»˜è®¤å€¼
    role.isConnecting = false
    role.isConnected = false
    role.showDigitalHuman = false
    role.digitalHumanInstance = null
    
    // 3. æ£€æŸ¥ rendererManager æ˜¯å¦å­˜åœ¨æ¸²æŸ“å™¨ï¼ˆçŠ¶æ€æ¢å¤ï¼‰
    const roleId = `user:${role.id}`
    const renderer = rendererManager.getRenderer(roleId)
    if (renderer) {
      // æ¢å¤è¿æ¥çŠ¶æ€
      role.isConnected = true
      role.showDigitalHuman = true
      if (renderer instanceof DigitalHumanRenderer) {
        role.digitalHumanInstance = renderer.getInstance()
      }
    }
  })
  
  // 4. æ›´æ–°æ•°ç»„
  userRoles.value = roleList
  
  // 5. æ›´æ–°å½“å‰è§’è‰²å¼•ç”¨
  const currentRole = roleList.find(r => r.isCurrent) || null
  appState.currentUserRole = currentRole
  
  // 6. æ¿€æ´»å½“å‰è§’è‰²
  if (currentRole) {
    await activateUserRole(currentRole)
  }
}
```

### 6.2 è¿æ¥æ“ä½œæ¨¡å¼ï¼ˆhandleConnectUserRoleFromListï¼‰

```typescript
async function handleConnectUserRoleFromList(role: UserRole) {
  // 1. å‰ç½®æ£€æŸ¥
  if (role.isConnecting || role.isConnected) return
  if (!role.avatarAppId || !role.avatarAppSecret) return
  if (appState.currentUserRole?.id !== role.id) return
  if (role.type !== 'digital_human') return
  
  const userRoleId = `user:${role.id}`
  
  // 2. è®¾ç½®è¿æ¥ä¸­çŠ¶æ€
  role.isConnecting = true
  role.showDigitalHuman = true
  await nextTick() // ç­‰å¾…DOMæ›´æ–°
  
  try {
    // 3. è·å–æˆ–åˆ›å»ºæ¸²æŸ“å™¨
    let renderer = rendererManager.getRenderer(userRoleId)
    if (!renderer) {
      renderer = await rendererManager.createRenderer(userRoleId, {
        roleId: userRoleId,
        roleType: 'digital_human',
        positionX: role.positionX ?? 50,
        positionY: role.positionY ?? 50,
        scale: role.scale ?? 1.0,
        avatarAppId: role.avatarAppId,
        avatarAppSecret: role.avatarAppSecret,
        containerId: 'digital-human-user'
      })
    }
    
    // 4. è®¾ç½®å®¹å™¨å’Œè¿æ¥
    const containerElement = document.getElementById('digital-human-user')
    if (!containerElement) {
      throw new Error('å®¹å™¨ä¸å­˜åœ¨')
    }
    
    await renderer.render(containerElement)
    await renderer.connect()
    
    // 5. è®¾ç½®è¿æ¥æˆåŠŸçŠ¶æ€ï¼ˆåŸå­æ€§ï¼‰
    if (renderer instanceof DigitalHumanRenderer) {
      role.digitalHumanInstance = renderer.getInstance()
    }
    role.isConnected = true
    role.isConnecting = false
    
  } catch (error) {
    // 6. é”™è¯¯å›æ»š
    role.isConnecting = false
    role.showDigitalHuman = false
    throw error
  }
}
```

### 6.3 æ–­å¼€æ“ä½œæ¨¡å¼ï¼ˆhandleDisconnectUserRoleFromListï¼‰

```typescript
async function handleDisconnectUserRoleFromList(role: UserRole) {
  const userRoleId = `user:${role.id}`
  const renderer = rendererManager.getRenderer(userRoleId)
  
  if (!renderer) {
    showToastMessage('è¯¥è§’è‰²æœªè¿æ¥', 'info')
    return
  }
  
  try {
    // 1. æ–­å¼€è¿æ¥
    if (renderer.disconnect) {
      await renderer.disconnect()
    }
    renderer.hide()
    
    // 2. æ¸…ç†çŠ¶æ€ï¼ˆåŸå­æ€§ï¼‰
    role.showDigitalHuman = false
    role.digitalHumanInstance = null
    role.isConnected = false
    role.isConnecting = false
    
    // 3. é”€æ¯æ¸²æŸ“å™¨ï¼ˆå¯é€‰ï¼‰
    rendererManager.destroyRenderer(userRoleId)
    
  } catch (error) {
    console.error('æ–­å¼€è¿æ¥å¤±è´¥:', error)
    throw error
  }
}
```

### 6.4 è§’è‰²åˆ‡æ¢æ¨¡å¼ï¼ˆhandleSetCurrentUserRoleï¼‰

```typescript
async function handleSetCurrentUserRole(role: UserRole) {
  try {
    // 1. å¤±æ´»æ—§è§’è‰²ï¼ˆåŸå­æ€§ï¼‰
    if (appState.currentUserRole) {
      await deactivateUserRole(appState.currentUserRole)
      // å†…éƒ¨ä¼šï¼š
      //   - æ–­å¼€è¿æ¥ï¼ˆå¦‚æœå·²è¿æ¥ï¼‰
      //   - æ¸…ç†å±æ€§
      //   - é”€æ¯æ¸²æŸ“å™¨
    }
    
    // 2. æ›´æ–°æ•°æ®åº“
    await setCurrentUserRole(role.id, globalApiKey.value)
    
    // 3. âŒ é‡æ–°åŠ è½½åˆ—è¡¨ï¼ˆçŠ¶æ€æ¢å¤ï¼‰
    // âŒ await loadUserRoles()  // âŒ **éœ€è¦ä¿®æ”¹**ï¼šä¸åº”è¯¥é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰²
    // âœ… åªæ›´æ–° isCurrent å±æ€§
    // âœ… userRoles.value.forEach(r => { r.isCurrent = (r.id === role.id) })
    
    // 4. æ›´æ–°å¼•ç”¨
    appState.currentUserRole = role
    
    // 5. æ¿€æ´»æ–°è§’è‰²ï¼ˆåŸå­æ€§ï¼‰
    await activateUserRole(role)
    // å†…éƒ¨ä¼šï¼š
    //   - è®¾ç½® showDigitalHuman = trueï¼ˆå¦‚æœæ˜¯æ•°å­—äººï¼‰
    
  } catch (error) {
    showToastMessage((error as Error).message, 'error')
  }
}
```

### 6.5 ç±»å‹å˜æ›´æ£€æŸ¥æ¨¡å¼ï¼ˆhandleSaveUserRole - ç¼–è¾‘ï¼‰

```typescript
async function handleSaveUserRole() {
  const editingRole = editingUserRole.value
  if (!editingRole) return
  
  // 1. æ£€æŸ¥ç±»å‹æ˜¯å¦å˜æ›´
  const oldRole = userRoles.value.find(r => r.id === editingRole.id)
  const typeChanged = oldRole?.type !== userRoleForm.value.type
  
  if (typeChanged && oldRole?.type === 'digital_human') {
    // 2. ä»æ•°å­—äººæ”¹ä¸ºç«‹ç»˜ï¼šæ¸…ç†æ•°å­—äººçŠ¶æ€
    const userRoleId = `user:${oldRole.id}`
    const renderer = rendererManager.getRenderer(userRoleId)
    
    if (renderer) {
      // æ–­å¼€è¿æ¥
      if (renderer.disconnect) {
        await renderer.disconnect()
      }
      // é”€æ¯æ¸²æŸ“å™¨
      rendererManager.destroyRenderer(userRoleId)
    }
    
    // æ¸…ç†å±æ€§ï¼ˆåœ¨é‡æ–°åŠ è½½åä¼šè¢«åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ï¼‰
  }
  
  // 3. æ›´æ–°æ•°æ®åº“
  let updatedRole: UserRole
  if (editingRole) {
    updatedRole = await updateUserRole(editingRole.id, globalApiKey.value, {...})
    // âœ… åªæ›´æ–°é‚£ä¸ªè§’è‰²çš„å±æ€§ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰²
    const roleIndex = userRoles.value.findIndex(r => r.id === editingRole.id)
    if (roleIndex !== -1) {
      // æ›´æ–°æ•°æ®åº“å±æ€§
      Object.assign(userRoles.value[roleIndex], updatedRole)
      // ä¿æŒå†…å­˜çŠ¶æ€å±æ€§ï¼ˆå¦‚æœç±»å‹æœªå˜æ›´ï¼‰
      if (!typeChanged) {
        // ä¿æŒåŸæœ‰çš„å†…å­˜çŠ¶æ€å±æ€§
      }
    }
  } else {
    updatedRole = await createUserRole(globalApiKey.value, {...})
    // âœ… åªæ·»åŠ æ–°è§’è‰²ï¼Œä¸é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰²
    updatedRole.isConnecting = false
    updatedRole.isConnected = false
    updatedRole.showDigitalHuman = false
    updatedRole.digitalHumanInstance = null
    userRoles.value.push(updatedRole)
  }
  
  // âŒ 4. é‡æ–°åŠ è½½åˆ—è¡¨ï¼ˆçŠ¶æ€æ¢å¤ï¼‰
  // âŒ await loadUserRoles()  // âŒ **éœ€è¦ä¿®æ”¹**ï¼šä¸åº”è¯¥é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰²
  
  // 5. å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰è§’è‰²ï¼Œæ›´æ–°å¼•ç”¨ï¼ˆä¿æŒå¼•ç”¨ä¸å˜ï¼Œåªæ›´æ–°å±æ€§ï¼‰
  if (appState.currentUserRole?.id === editingRole?.id || appState.currentUserRole?.id === updatedRole.id) {
    const roleInList = userRoles.value.find(r => r.id === updatedRole.id)
    if (roleInList) {
      // å¦‚æœå¼•ç”¨ä¸åŒï¼Œæ›´æ–°å¼•ç”¨ï¼›å¦åˆ™å¼•ç”¨å·²æŒ‡å‘åˆ—è¡¨ä¸­çš„å¯¹è±¡ï¼Œåªéœ€æ›´æ–°å±æ€§
      if (appState.currentUserRole !== roleInList) {
        appState.currentUserRole = roleInList
      }
    }
  }
}
```

## ä¸ƒã€å±æ€§å˜æ›´çš„éªŒè¯è§„åˆ™

### 7.1 å±æ€§å€¼çš„åˆæ³•æ€§æ£€æŸ¥

#### 7.1.1 isConnecting
- **åˆæ³•å€¼ï¼š** `true` | `false`
- **çº¦æŸï¼š** 
  - å½“ `isConnecting === true` æ—¶ï¼Œ`isConnected` å¿…é¡»ä¸º `false`
  - å½“ `isConnecting === true` æ—¶ï¼Œ`showDigitalHuman` åº”è¯¥ä¸º `true`ï¼ˆæ˜¾ç¤ºå®¹å™¨ï¼‰

#### 7.1.2 isConnected
- **åˆæ³•å€¼ï¼š** `true` | `false`
- **çº¦æŸï¼š**
  - å½“ `isConnected === true` æ—¶ï¼Œ`digitalHumanInstance` å¿…é¡»ä¸ä¸º `null`
  - å½“ `isConnected === true` æ—¶ï¼Œ`rendererManager.getRenderer(roleId)` å¿…é¡»å­˜åœ¨
  - å½“ `isConnected === true` æ—¶ï¼Œ`role.type` å¿…é¡»ä¸º `'digital_human'`

#### 7.1.3 showDigitalHuman
- **åˆæ³•å€¼ï¼š** `true` | `false`
- **çº¦æŸï¼š**
  - å½“ `showDigitalHuman === true` æ—¶ï¼Œ`role.type` å¿…é¡»ä¸º `'digital_human'`
  - å½“ `showDigitalHuman === true` ä¸” `isConnected === true` æ—¶ï¼Œå®¹å™¨åº”è¯¥å¯è§

#### 7.1.4 digitalHumanInstance
- **åˆæ³•å€¼ï¼š** `DigitalHumanInstance | null`
- **çº¦æŸï¼š**
  - å½“ `digitalHumanInstance !== null` æ—¶ï¼Œ`isConnected` å¿…é¡»ä¸º `true`
  - å½“ `digitalHumanInstance !== null` æ—¶ï¼Œ`rendererManager.getRenderer(roleId)` å¿…é¡»å­˜åœ¨

### 7.2 å±æ€§ä¸€è‡´æ€§æ£€æŸ¥

åœ¨å…³é”®æ“ä½œåï¼Œåº”è¯¥éªŒè¯å±æ€§çš„ä¸€è‡´æ€§ï¼š

```typescript
function validateRoleState(role: UserRole | Role): boolean {
  const roleId = getRoleId(role)
  const renderer = rendererManager.getRenderer(roleId)
  
  // æ£€æŸ¥1ï¼šisConnected ä¸ digitalHumanInstance çš„ä¸€è‡´æ€§
  if (role.isConnected && !role.digitalHumanInstance) {
    console.error('çŠ¶æ€ä¸ä¸€è‡´ï¼šisConnected=true ä½† digitalHumanInstance=null', role)
    return false
  }
  
  // æ£€æŸ¥2ï¼šisConnected ä¸ renderer çš„ä¸€è‡´æ€§
  if (role.isConnected && !renderer) {
    console.error('çŠ¶æ€ä¸ä¸€è‡´ï¼šisConnected=true ä½† renderer ä¸å­˜åœ¨', role)
    return false
  }
  
  // æ£€æŸ¥3ï¼šdigitalHumanInstance ä¸ renderer çš„ä¸€è‡´æ€§
  if (role.digitalHumanInstance && renderer instanceof DigitalHumanRenderer) {
    const instance = renderer.getInstance()
    if (role.digitalHumanInstance !== instance) {
      console.error('çŠ¶æ€ä¸ä¸€è‡´ï¼šdigitalHumanInstance ä¸ renderer.getInstance() ä¸åŒ¹é…', role)
      return false
    }
  }
  
  // æ£€æŸ¥4ï¼šisConnecting ä¸ isConnected çš„äº’æ–¥æ€§
  if (role.isConnecting && role.isConnected) {
    console.error('çŠ¶æ€ä¸ä¸€è‡´ï¼šisConnecting=true ä¸” isConnected=true', role)
    return false
  }
  
  return true
}
```

## å…«ã€å±æ€§å˜æ›´çš„è°ƒè¯•å’Œç›‘æ§

### 8.1 å±æ€§å˜æ›´æ—¥å¿—

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå¯ä»¥æ·»åŠ å±æ€§å˜æ›´æ—¥å¿—ï¼š

```typescript
function logPropertyChange(
  role: UserRole | Role,
  property: string,
  oldValue: any,
  newValue: any,
  event: string
) {
  if (process.env.NODE_ENV === 'development') {
    console.log(`[å±æ€§å˜æ›´] ${event}`, {
      roleId: getRoleId(role),
      property,
      oldValue,
      newValue,
      timestamp: new Date().toISOString()
    })
  }
}
```

### 8.2 å±æ€§å¿«ç…§

åœ¨å…³é”®æ“ä½œå‰åï¼Œå¯ä»¥åˆ›å»ºå±æ€§å¿«ç…§ç”¨äºè°ƒè¯•ï¼š

```typescript
function createRoleSnapshot(role: UserRole | Role) {
  return {
    id: role.id,
    type: role.type,
    isConnecting: role.isConnecting,
    isConnected: role.isConnected,
    showDigitalHuman: role.showDigitalHuman,
    hasInstance: role.digitalHumanInstance !== null,
    rendererExists: rendererManager.getRenderer(getRoleId(role)) !== undefined
  }
}
```

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒåŸåˆ™

1. **å±æ€§çº§åˆ«çš„ç²¾ç¡®ç»´æŠ¤**ï¼šæ¯ä¸ªå±æ€§çš„å˜æ›´éƒ½æœ‰æ˜ç¡®çš„é€»è¾‘å’Œè§„åˆ™
2. **çŠ¶æ€æ¢å¤æœºåˆ¶**ï¼šä»æ•°æ®åº“åŠ è½½æ—¶ï¼Œéœ€è¦ä» `rendererManager` æ¢å¤è¿æ¥çŠ¶æ€
3. **åŸå­æ€§ä¿è¯**ï¼šå…³é”®æ“ä½œï¼ˆè¿æ¥ã€æ–­å¼€ã€åˆ‡æ¢ï¼‰éœ€è¦ä¿è¯å±æ€§çš„åŸå­æ€§å˜æ›´
4. **ä¾èµ–æ£€æŸ¥**ï¼šæ“ä½œå‰éœ€è¦æ£€æŸ¥å±æ€§çš„ä¾èµ–å…³ç³»
5. **ä¸€è‡´æ€§éªŒè¯**ï¼šå…³é”®æ“ä½œåéœ€è¦éªŒè¯å±æ€§çš„ä¸€è‡´æ€§

### 9.2 å®ç°ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼š
   - çŠ¶æ€æ¢å¤æœºåˆ¶ï¼ˆ`loadUserRoles` / `loadRoles`ï¼‰
   - è¿æ¥/æ–­å¼€æ“ä½œçš„åŸå­æ€§ä¿è¯
   - è§’è‰²åˆ‡æ¢æ—¶çš„çŠ¶æ€è¿ç§»

2. **ä¸­ä¼˜å…ˆçº§**ï¼š
   - ç±»å‹å˜æ›´æ£€æŸ¥
   - å±æ€§ä¸€è‡´æ€§éªŒè¯
   - é”™è¯¯å›æ»šæœºåˆ¶

3. **ä½ä¼˜å…ˆçº§**ï¼š
   - å±æ€§å˜æ›´æ—¥å¿—
   - å±æ€§å¿«ç…§
   - æ€§èƒ½ä¼˜åŒ–

### 9.3 æ³¨æ„äº‹é¡¹

1. **é¿å…é‡å¤åˆå§‹åŒ–**ï¼šä¸è¦åœ¨æ¯æ¬¡æ‰“å¼€é¢æ¿æ—¶é‡æ–°åŠ è½½å’Œåˆå§‹åŒ–ï¼Œåªåœ¨ç™»å½•æ—¶åˆå§‹åŒ–
2. **ä¿æŒå¼•ç”¨ä¸€è‡´æ€§**ï¼š`appState.currentUserRole` å’Œ `appState.currentPartnerRole` å¿…é¡»å¼•ç”¨ `userRoles` / `roles` æ•°ç»„ä¸­çš„å¯¹è±¡
3. **æ¸²æŸ“å™¨ç”Ÿå‘½å‘¨æœŸ**ï¼šæ¸²æŸ“å™¨çš„åˆ›å»ºå’Œé”€æ¯å¿…é¡»ä¸è§’è‰²å¯¹è±¡çš„å±æ€§çŠ¶æ€ä¿æŒä¸€è‡´
4. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½éœ€è¦æœ‰é”™è¯¯å¤„ç†å’ŒçŠ¶æ€å›æ»šæœºåˆ¶

## åã€å¾…ä¿®æ”¹é¡¹

### 10.1 ä¼™ä¼´è§’è‰²ç±»å‹é‡å‘½å

**é—®é¢˜ï¼š** ä¼™ä¼´è§’è‰²ä¸åº”è¯¥ç”¨ `Role` ä½œä¸ºå˜é‡åï¼Œåº”è¯¥ç”¨ `PartnerRole`ï¼Œé¿å…ä¸ç”¨æˆ·è§’è‰²çš„ä¸Šå±‚æ¦‚å¿µæ··æ·†ã€‚

**éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼š**

1. **ç±»å‹å®šä¹‰å’Œå¼•ç”¨**
   - `appState.currentPartnerRole: Role | null` â†’ `appState.currentPartnerRole: PartnerRole | null`
   - `roles: Role[]` â†’ `roles: PartnerRole[]`
   - æ–‡æ¡£æ ‡é¢˜ï¼š`è§’è‰²å¯¹è±¡å±æ€§ï¼ˆRole/UserRoleï¼‰` â†’ `è§’è‰²å¯¹è±¡å±æ€§ï¼ˆPartnerRole/UserRoleï¼‰`

2. **å‡½æ•°å‚æ•°å’Œå˜é‡**
   - æ‰€æœ‰å‡½æ•°å‚æ•° `role: Role` â†’ `role: PartnerRole` æˆ– `partnerRole: PartnerRole`
   - ç¤ºä¾‹ä»£ç ä¸­çš„å˜é‡å£°æ˜

3. **è”åˆç±»å‹**
   - `UserRole | Role` â†’ `UserRole | PartnerRole`
   - å‡ºç°åœ¨ï¼š`validateRoleState(role: UserRole | Role)`ã€`logPropertyChange(role: UserRole | Role, ...)`ã€`createRoleSnapshot(role: UserRole | Role)`

4. **ç¤ºä¾‹ä»£ç **
   - æ‰€æœ‰æ¶‰åŠä¼™ä¼´è§’è‰²çš„ç¤ºä¾‹ä»£ç ä¸­çš„ç±»å‹å£°æ˜

### 10.2 æ–‡æ¡£æ ‡æ³¨é—®é¢˜ä¿®å¤

**é—®é¢˜1ï¼š** ç¬¬13è¡Œ - `user` å­—æ®µè¯´æ˜é”™è¯¯
- **å½“å‰ï¼š** `user: string` - userå­—æ®µï¼ˆä¼™ä¼´è§’è‰²ï¼‰æˆ– `apiKey: string`ï¼ˆç”¨æˆ·è§’è‰²ï¼‰
- **é—®é¢˜ï¼š** ç”¨æˆ·ä¹Ÿæœ‰å¤šè§’è‰²ï¼Œè§’è‰²åœ¨å¯¹è±¡çº§åˆ«æ˜¯ä¸€è‡´çš„
- **ä¿®å¤ï¼š** éœ€è¦é‡æ–°è¯´æ˜ `user` å­—æ®µçš„å«ä¹‰ï¼Œç”¨æˆ·è§’è‰²å’Œä¼™ä¼´è§’è‰²åœ¨å¯¹è±¡çº§åˆ«åº”è¯¥ä¸€è‡´

**é—®é¢˜2ï¼š** ç¬¬22è¡Œ - `apiKey` å­—æ®µè¯´æ˜é”™è¯¯
- **å½“å‰ï¼š** `apiKey?: string` - å¤§æ¨¡å‹API Keyï¼ˆä»…ä¼™ä¼´è§’è‰²ï¼‰
- **é—®é¢˜ï¼š** ç”¨æˆ·è§’è‰²ä¹Ÿè¦å¡«å†™æ­¤å­—æ®µï¼Œè°ƒç”¨å¤§æ¨¡å‹æ—¶ç»Ÿä¸€ä½¿ç”¨æ­¤å­—æ®µ
- **ä¿®å¤ï¼š** æ”¹ä¸ºï¼š`apiKey?: string` - å¤§æ¨¡å‹API Keyï¼ˆç”¨æˆ·è§’è‰²å’Œä¼™ä¼´è§’è‰²éƒ½éœ€è¦ï¼‰

**é—®é¢˜3ï¼š** ç¬¬40è¡Œ - ç”¨æˆ·è§’è‰²çš„ `roleId` æ ¼å¼è¯´æ˜é”™è¯¯
- **å½“å‰ï¼š** ç”¨æˆ·è§’è‰²ï¼š`user:${role.id}`ï¼Œä¼™ä¼´è§’è‰²ï¼š`partner:${role.user}`
- **é—®é¢˜ï¼š** åº”è¯¥å’Œä¼™ä¼´è§’è‰²ä¸€è‡´ï¼Œä¸è¦æä¸¤å¥—é€»è¾‘
- **ä¿®å¤ï¼š** éœ€è¦ç»Ÿä¸€ `roleId` çš„æ ¼å¼è§„åˆ™ï¼Œç”¨æˆ·è§’è‰²å’Œä¼™ä¼´è§’è‰²åº”è¯¥ä½¿ç”¨ä¸€è‡´çš„é€»è¾‘

### 10.3 æ•°æ®åº“æ“ä½œåŸåˆ™è¿åé¡¹

**æ ¸å¿ƒåŸåˆ™ï¼šåƒæ“ä½œæ•°æ®åº“ä¸€æ ·ç»´æŠ¤å†…å­˜çŠ¶æ€**

ä»¥ä¸‹æ“ä½œè¿åäº†"ç²¾ç¡®æ›´æ–°"åŸåˆ™ï¼Œéœ€è¦ä¿®æ”¹ï¼š

1. **åˆ›å»ºç”¨æˆ·è§’è‰²ï¼ˆ3.3ï¼‰**ï¼šâŒ é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² â†’ âœ… åªæ·»åŠ æ–°è§’è‰²
2. **æ›´æ–°ç”¨æˆ·è§’è‰²ï¼ˆ3.4ï¼‰**ï¼šâŒ é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² â†’ âœ… åªæ›´æ–°é‚£ä¸ªè§’è‰²çš„å±æ€§
3. **åˆ é™¤ç”¨æˆ·è§’è‰²ï¼ˆ3.5ï¼‰**ï¼šâŒ é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² â†’ âœ… åªä»åˆ—è¡¨ä¸­ç§»é™¤é‚£ä¸ªè§’è‰²
4. **è®¾ç½®å½“å‰ç”¨æˆ·è§’è‰²ï¼ˆ3.6ï¼‰**ï¼šâŒ é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² â†’ âœ… åªæ›´æ–° `isCurrent` å±æ€§
5. **åˆ›å»ºä¼™ä¼´è§’è‰²ï¼ˆ3.10ï¼‰**ï¼šâŒ é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² â†’ âœ… åªæ·»åŠ æ–°è§’è‰²
6. **æ›´æ–°ä¼™ä¼´è§’è‰²ï¼ˆ3.11ï¼‰**ï¼šâŒ é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² â†’ âœ… åªæ›´æ–°é‚£ä¸ªè§’è‰²çš„å±æ€§
7. **åˆ é™¤ä¼™ä¼´è§’è‰²ï¼ˆ3.12ï¼‰**ï¼šâŒ é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² â†’ âœ… åªä»åˆ—è¡¨ä¸­ç§»é™¤é‚£ä¸ªè§’è‰²
8. **è®¾ç½®å½“å‰ä¼™ä¼´è§’è‰²ï¼ˆ3.13ï¼‰**ï¼šâŒ é‡æ–°åŠ è½½æ‰€æœ‰è§’è‰² â†’ âœ… ä¸éœ€è¦é‡æ–°åŠ è½½ï¼ˆä¼™ä¼´è§’è‰²æ²¡æœ‰ `isCurrent` å­—æ®µï¼‰

### 10.4 ä¿®æ”¹ä¼˜å…ˆçº§

1. **æœ€é«˜ä¼˜å…ˆçº§ï¼š** æ•°æ®åº“æ“ä½œåŸåˆ™è¿åé¡¹ï¼ˆå½±å“æ€§èƒ½å’ŒçŠ¶æ€ä¸€è‡´æ€§ï¼‰
2. **é«˜ä¼˜å…ˆçº§ï¼š** ç±»å‹é‡å‘½åï¼ˆå½±å“ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§ï¼‰
3. **ä¸­ä¼˜å…ˆçº§ï¼š** æ–‡æ¡£æ ‡æ³¨é—®é¢˜ä¿®å¤ï¼ˆå½±å“æ–‡æ¡£å‡†ç¡®æ€§ï¼‰
4. **ä½ä¼˜å…ˆçº§ï¼š** ç¤ºä¾‹ä»£ç æ›´æ–°ï¼ˆä¸å½±å“åŠŸèƒ½ï¼Œä½†å½±å“æ–‡æ¡£å®Œæ•´æ€§ï¼‰