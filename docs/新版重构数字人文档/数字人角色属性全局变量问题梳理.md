# 数字人角色属性全局变量问题梳理

## 一、问题说明

**核心问题：** 数字人的角色属性应该定义在角色对象上，而不是使用全局变量管理。

**原则：** 所有角色属性都应该定义在角色对象上，每个角色独立，互不干扰。

---

## 二、当前发现的全局变量问题

### 2.1 连接状态相关

#### ✅ 已清理：`appState.avatar.connected` (boolean)

**状态：** ✅ **已完全清理**

**原实现：**
- 全局布尔值，表示数字人是否已连接
- 用于判断连接状态

**清理结果：**
- ✅ 已从 `appState.avatar` 中移除
- ✅ 已从类型定义中移除
- ✅ 所有使用位置已改为 `role.isConnected`
- ✅ 所有使用位置已改为 `appState.currentUserRole?.isConnected` 或 `appState.currentPartnerRole?.isConnected`

**清理位置：**
- `src/stores/app.ts` - 已移除初始化
- `src/types/index.ts` - 已从类型定义中移除
- `src/components/ConfigPanel.vue` - 所有使用已改为角色级别状态
- `src/components/AvatarRender.vue` - 已改为使用角色级别状态
- `src/stores/app.ts` - `sendMessage()` 和 `waitForAvatarReady()` 已改为使用角色级别状态

---

#### ✅ 已清理：`appState.avatar.instance` (any)

**状态：** ✅ **已完全清理**

**原实现：**
- 全局变量，存储数字人SDK实例
- 用于调用SDK方法

**清理结果：**
- ✅ 已从 `appState.avatar` 中移除
- ✅ 已从类型定义中移除
- ✅ 所有使用位置已改为 `role.digitalHumanInstance`
- ✅ 所有使用位置已改为 `appState.currentUserRole?.digitalHumanInstance`

**清理位置：**
- `src/stores/app.ts` - 已移除初始化，`disconnectAvatar()` 已废弃
- `src/types/index.ts` - 已从类型定义中移除
- `src/stores/app.ts` - `sendMessage()` 和 `waitForAvatarReady()` 已改为使用角色级别状态

---

#### ✅ 已清理：`appState.avatar.connectedRoles` (Set<string>)

**状态：** ✅ **已完全清理**（代码中已不存在）

**原实现：**
- 全局 Set，存储已连接的角色ID（如 `partner:${role.user}` 或 `user:${role.id}`）
- 用于判断角色是否已连接

**清理结果：**
- ✅ 已从 `appState.avatar` 中移除
- ✅ 已从类型定义中移除
- ✅ 所有使用位置已改为 `role.isConnected`
- ✅ 代码中已不存在此变量

**替代方案：**
- 在 `Role` 接口中添加 `isConnected?: boolean`
- 在 `UserRole` 接口中添加 `isConnected?: boolean`
- 每个角色对象独立管理自己的连接状态

---

### 2.2 显示状态相关

#### ✅ 已清理：`appState.avatar.showUserDigitalHuman` (boolean)

**状态：** ✅ **已完全清理**（代码中已不存在）

**原实现：**
- 全局布尔值，控制用户数字人容器的显示/隐藏
- 通过 `v-if` 绑定到模板

**清理结果：**
- ✅ 已从 `appState.avatar` 中移除
- ✅ 已从类型定义中移除
- ✅ 所有使用位置已改为 `role.showDigitalHuman`
- ✅ 所有使用位置已改为 `appState.currentUserRole?.showDigitalHuman`
- ✅ 代码中已不存在此变量

**替代方案：**
- 在 `UserRole` 接口中添加 `showDigitalHuman?: boolean`
- 每个用户角色对象独立管理自己的显示状态

---

#### ✅ 已清理：`appState.avatar.showPartnerDigitalHuman` (boolean)

**状态：** ✅ **已完全清理**（代码中已不存在）

**原实现：**
- 全局布尔值，控制伙伴数字人容器的显示/隐藏
- 通过 `v-if` 绑定到模板

**清理结果：**
- ✅ 已从 `appState.avatar` 中移除
- ✅ 已从类型定义中移除
- ✅ 所有使用位置已改为 `role.showDigitalHuman`
- ✅ 所有使用位置已改为 `appState.currentPartnerRole?.showDigitalHuman`
- ✅ 代码中已不存在此变量

**替代方案：**
- 在 `Role` 接口中添加 `showDigitalHuman?: boolean`
- 每个伙伴角色对象独立管理自己的显示状态

---

### 2.3 实例管理相关

#### ✅ 已清理：`appState.avatar.instances` (Map<string, DigitalHumanInstance>)

**状态：** ✅ **已完全清理**（代码中已不存在）

**原实现：**
- 全局 Map，存储角色ID到数字人SDK实例的映射
- 用于管理数字人实例

**清理结果：**
- ✅ 已从 `appState.avatar` 中移除
- ✅ 已从类型定义中移除
- ✅ 所有使用位置已改为 `role.digitalHumanInstance`
- ✅ 所有使用位置已改为 `appState.currentUserRole?.digitalHumanInstance` 或 `appState.currentPartnerRole?.digitalHumanInstance`
- ✅ 代码中已不存在此变量

**替代方案：**
- 在 `Role` 接口中添加 `digitalHumanInstance?: DigitalHumanInstance | null`
- 在 `UserRole` 接口中添加 `digitalHumanInstance?: DigitalHumanInstance | null`
- 每个角色对象独立存储自己的数字人实例

**注意：**
- 实例类型需要从 `DigitalHumanService` 或相关类型定义中导入
- 需要确保类型定义正确

---

## 三、需要修改的代码位置

### 3.1 类型定义修改

**文件：** `src/types/index.ts`

**需要添加的属性：**

```typescript
export interface Role {
  // ... 现有属性
  isConnected?: boolean           // 是否已连接（替代 connectedRoles Set）
  showDigitalHuman?: boolean       // 是否显示数字人（替代 showPartnerDigitalHuman）
  digitalHumanInstance?: any | null // 数字人SDK实例（替代 instances Map）
  // ... 其他属性
}

export interface UserRole {
  // ... 现有属性
  isConnected?: boolean           // 是否已连接（替代 connectedRoles Set）
  showDigitalHuman?: boolean       // 是否显示数字人（替代 showUserDigitalHuman）
  digitalHumanInstance?: any | null // 数字人SDK实例（替代 instances Map）
  // ... 其他属性
}
```

---

### 3.2 状态管理修改

**文件：** `src/stores/app.ts`

**所有全局变量状态：**

**已清理的全局变量：**
- ✅ `appState.avatar.connected` (boolean) - **已清理**
- ✅ `appState.avatar.instance` (any) - **已清理**
- ✅ `appState.avatar.connectedRoles` (Set<string>) - **已清理**（代码中已不存在）
- ✅ `appState.avatar.instances` (Map<string, DigitalHumanInstance>) - **已清理**（代码中已不存在）
- ✅ `appState.avatar.showUserDigitalHuman` (boolean) - **已清理**（代码中已不存在）
- ✅ `appState.avatar.showPartnerDigitalHuman` (boolean) - **已清理**（代码中已不存在）

**注意：**
- 这些全局变量需要完全删除，不能保留
- 所有使用这些变量的地方都需要改为使用角色对象上的属性

---

### 3.3 组件修改

**文件：** `src/components/ConfigPanel.vue`

**需要修改的位置：**

1. **按钮 disabled 判断：**
   - `appState.avatar.connectedRoles.has(...)` → `role.isConnected`
   - `appState.avatar.showPartnerDigitalHuman` → `role.showDigitalHuman`
   - `appState.avatar.showUserDigitalHuman` → `role.showDigitalHuman`

2. **连接函数：**
   - `appState.avatar.connectedRoles.add(...)` → `role.isConnected = true`
   - `appState.avatar.instances.set(...)` → `role.digitalHumanInstance = instance`
   - `appState.avatar.showPartnerDigitalHuman = true` → `role.showDigitalHuman = true`
   - `appState.avatar.showUserDigitalHuman = true` → `role.showDigitalHuman = true`

3. **断开函数：**
   - `appState.avatar.connectedRoles.delete(...)` → `role.isConnected = false`
   - `appState.avatar.instances.delete(...)` → `role.digitalHumanInstance = null`
   - `appState.avatar.showPartnerDigitalHuman = false` → `role.showDigitalHuman = false`
   - `appState.avatar.showUserDigitalHuman = false` → `role.showDigitalHuman = false`

4. **激活/失活函数：**
   - `appState.avatar.showPartnerDigitalHuman = true` → `role.showDigitalHuman = true`
   - `appState.avatar.showUserDigitalHuman = true` → `role.showDigitalHuman = true`
   - `appState.avatar.showPartnerDigitalHuman = false` → `role.showDigitalHuman = false`
   - `appState.avatar.showUserDigitalHuman = false` → `role.showDigitalHuman = false`

---

**文件：** `src/components/AvatarRender.vue`

**需要修改的位置：**

1. **模板中的 v-if：**
   - `v-if="appState.avatar.showPartnerDigitalHuman && ..."` → `v-if="appState.currentPartnerRole?.showDigitalHuman && ..."`
   - `v-if="appState.avatar.showUserDigitalHuman && ..."` → `v-if="appState.currentUserRole?.showDigitalHuman && ..."`

2. **渲染器设置函数：**
   - 所有使用 `appState.avatar.showPartnerDigitalHuman` 的地方改为 `appState.currentPartnerRole?.showDigitalHuman`
   - 所有使用 `appState.avatar.showUserDigitalHuman` 的地方改为 `appState.currentUserRole?.showDigitalHuman`

---

### 3.4 初始化修改

**文件：** `src/components/ConfigPanel.vue`

**在 `loadUserRoles()` 和 `loadRoles()` 中：**

需要初始化新添加的属性：
- `role.isConnected = false`（如果未定义）
- `role.showDigitalHuman = false`（如果未定义）
- `role.digitalHumanInstance = null`（如果未定义）

---

## 四、修改原则

### 4.1 核心原则

1. **所有角色属性都定义在角色对象上**
   - 不使用全局变量管理角色属性
   - 不使用数组/Map/Set 管理角色属性
   - 每个角色对象独立管理自己的所有属性

2. **完全删除全局变量**
   - 不保留全局变量作为"兼容"或"备用"
   - 不兼容、不回退、错误直接暴露

3. **角色独立性**
   - 用户角色和伙伴角色完全独立
   - 每个角色对象的所有属性都是独立的
   - 修改一个角色的属性不影响其他角色

---

### 4.2 修改步骤

1. **第一步：添加类型定义**
   - 在 `Role` 和 `UserRole` 接口中添加新属性

2. **第二步：修改所有使用位置**
   - 将所有使用全局变量的地方改为使用角色对象属性

3. **第三步：删除全局变量**
   - 从 `appState.avatar` 中删除相关全局变量

4. **第四步：初始化属性**
   - 在加载角色列表时初始化新属性

5. **第五步：验证**
   - 确保所有功能正常
   - 确保角色之间互不干扰

---

## 五、注意事项

### 5.1 类型定义

- `digitalHumanInstance` 的类型需要从 SDK 类型定义中导入
- 如果类型定义不明确，可以先使用 `any`，后续再完善

### 5.2 响应式更新

- Vue 的响应式系统会自动处理对象属性的变化
- 确保角色对象本身是响应式的（通过 `reactive` 或 `ref`）

### 5.3 模板绑定

- 模板中的绑定需要改为可选链操作符 `?.`，因为角色可能为 `null`
- 例如：`appState.currentPartnerRole?.showDigitalHuman`

### 5.4 实例管理

- 数字人实例需要在角色对象上正确存储和清理
- 断开连接时需要将 `digitalHumanInstance` 设置为 `null`
- 切换角色时需要清理旧角色的实例

---

## 六、总结

### 6.1 需要迁移的属性

| 全局变量 | 应该改为 | 类型 | 状态 |
|---------|---------|------|------|
| `appState.avatar.connected` | `role.isConnected` | `boolean` | ✅ **已清理** |
| `appState.avatar.instance` | `role.digitalHumanInstance` | `DigitalHumanInstance \| null` | ✅ **已清理** |
| `appState.avatar.connectedRoles` (Set) | `role.isConnected` | `boolean` | ✅ **已清理**（代码中已不存在） |
| `appState.avatar.showUserDigitalHuman` | `userRole.showDigitalHuman` | `boolean` | ✅ **已清理**（代码中已不存在） |
| `appState.avatar.showPartnerDigitalHuman` | `role.showDigitalHuman` | `boolean` | ✅ **已清理**（代码中已不存在） |
| `appState.avatar.instances` (Map) | `role.digitalHumanInstance` | `DigitalHumanInstance \| null` | ✅ **已清理**（代码中已不存在） |

### 6.2 修改范围

- ✅ **仅限数字人**：只修改数字人相关的属性，不动立绘角色
- ✅ **完全独立**：每个角色对象独立管理自己的所有属性
- ✅ **彻底删除**：完全删除全局变量，不保留任何"兼容"代码

### 6.3 预期效果

- ✅ 每个角色的连接状态独立
- ✅ 每个角色的显示状态独立
- ✅ 每个角色的数字人实例独立
- ✅ 用户角色和伙伴角色完全互不干扰
- ✅ 代码更清晰，逻辑更简单

