# 用户角色状态管理流程梳理

## 问题描述
用户角色连接显示成功后，从菜单再进入角色管理面板，角色会消失、连接会恢复未连接状态，但是又会弹出"连接成功"的消息。

## 当前处理流程

### 1. 打开角色管理面板
**函数：** `handleOpenUserRoleManagement()`
```typescript
async function handleOpenUserRoleManagement() {
  showUserRoleManagementModal.value = true
  showMenu.value = false
  
  // ✅ 修复：不在这里加载用户角色列表
  // 原因：
  // 1. 登录时已经加载过了（handleLogin）
  // 2. 保存/删除/切换角色时会重新加载
  // 3. 打开面板只是为了显示，不需要重新加载和初始化，避免丢失连接状态
}
```

### 2. 加载用户角色列表
**函数：** `loadUserRoles()`
```typescript
async function loadUserRoles() {
  // 1. 从API获取角色列表（新对象）
  const roleList = await getUserRoles(globalApiKey.value)
  
  // 2. ⚠️ 问题点2：初始化所有角色的数字人属性为默认值
  roleList.forEach(role => {
    if (role.isConnecting === undefined) {
      role.isConnecting = false
    }
    if (role.isConnected === undefined) {
      role.isConnected = false  // ⚠️ 丢失之前的连接状态
    }
    if (role.showDigitalHuman === undefined) {
      role.showDigitalHuman = false  // ⚠️ 丢失之前的显示状态
    }
    if (role.digitalHumanInstance === undefined) {
      role.digitalHumanInstance = null  // ⚠️ 丢失之前的实例引用
    }
  })
  
  // 3. 更新角色列表
  userRoles.value = roleList
  
  // 4. 查找当前角色（新对象）
  const currentRole = roleList.find(r => r.isCurrent) || null
  appState.currentUserRole = currentRole  // ⚠️ 问题点3：替换为新对象，丢失连接状态
  
  // 5. 如果设置了当前角色，激活用户角色
  if (currentRole) {
    // ... 应用配置 ...
    await activateUserRole(currentRole)  // ⚠️ 问题点4：激活新对象，但渲染器可能还存在
  }
}
```

### 3. 激活用户角色
**函数：** `activateUserRole(role: UserRole | null)`
```typescript
async function activateUserRole(role: UserRole | null) {
  if (!role) return
  
  if (role.type === 'illustration') {
    activateUserIllustration(role)
  } else if (role.type === 'digital_human') {
    activateUserDigitalHuman(role)  // ⚠️ 问题点5：只设置显示状态，不检查渲染器
  }
}
```

### 4. 激活用户数字人
**函数：** `activateUserDigitalHuman(role: UserRole)`
```typescript
function activateUserDigitalHuman(role: UserRole) {
  // ⚠️ 问题点6：只设置显示状态，不检查渲染器是否存在
  // 如果渲染器已存在且已连接，应该恢复连接状态
  role.showDigitalHuman = true
}
```

### 5. 连接用户角色数字人
**函数：** `handleConnectUserRoleFromList(role: UserRole)`
```typescript
async function handleConnectUserRoleFromList(role: UserRole) {
  // ... 验证 ...
  
  const userRoleId = `user:${role.id}`
  role.isConnecting = true
  
  try {
    // 1. 设置显示状态
    role.showDigitalHuman = true
    await nextTick()
    
    // 2. 获取或创建渲染器
    let renderer = rendererManager.getRenderer(userRoleId)
    if (!renderer) {
      // 创建新渲染器
      renderer = await rendererManager.createRenderer(userRoleId, {...})
    }
    
    // 3. 连接SDK
    await renderer.render(containerElement)
    await renderer.connect()
    
    // 4. 保存状态到角色对象
    role.digitalHumanInstance = instance
    role.isConnected = true
    
    showToastMessage('连接成功', 'success')
  } catch (error) {
    // ...
  } finally {
    role.isConnecting = false
  }
}
```

## 问题分析

### 核心问题
1. **状态丢失**：`loadUserRoles()` 从API获取新对象，丢失了内存中的连接状态（`isConnected`、`showDigitalHuman`、`digitalHumanInstance`）
2. **渲染器残留**：渲染器仍然存在于 `rendererManager` 中（key: `user:${role.id}`），但角色对象没有引用它
3. **状态不一致**：`activateUserDigitalHuman()` 只设置 `showDigitalHuman = true`，但不检查渲染器是否存在，导致状态不一致

### 问题流程
```
1. 用户连接成功
   - role.isConnected = true
   - role.showDigitalHuman = true
   - role.digitalHumanInstance = instance
   - rendererManager 中存储了渲染器

2. 打开角色管理面板
   - loadUserRoles() 被调用
   - 从API获取新对象（没有连接状态）
   - 初始化所有属性为默认值（isConnected=false）
   - appState.currentUserRole = 新对象（丢失连接状态）

3. activateUserRole() 被调用
   - activateUserDigitalHuman() 设置 showDigitalHuman = true
   - 但 isConnected 仍然是 false
   - 渲染器仍然存在，但角色对象没有引用

4. 如果渲染器已连接，可能会触发某些逻辑
   - 导致"连接成功"消息弹出
   - 但角色对象的 isConnected 仍然是 false
```

## 修复方案

### 核心修复：移除打开面板时的重新加载
**问题核心：初始化应该只在 apikey 登录时进行，而不是每次打开面板的时候。**

在 `handleOpenUserRoleManagement()` 中，移除 `loadUserRoles()` 调用：

```typescript
async function handleOpenUserRoleManagement() {
  showUserRoleManagementModal.value = true
  showMenu.value = false
  
  // ✅ 不在这里加载用户角色列表
  // 原因：
  // 1. 登录时已经加载过了（handleLogin）
  // 2. 保存/删除/切换角色时会重新加载
  // 3. 打开面板只是为了显示，不需要重新加载和初始化，避免丢失连接状态
}
```

### 为什么这样修复？
1. **登录时已加载**：`handleLogin()` 中已经调用了 `loadUserRoles()`，此时初始化是正确的
2. **操作时会重新加载**：保存、删除、切换角色时会重新加载，确保数据同步
3. **打开面板只是显示**：打开面板只是为了查看和操作，不需要重新加载，避免丢失内存中的连接状态

### 其他需要重新加载的场景（保持不变）
以下场景仍然需要调用 `loadUserRoles()`：
- ✅ 登录时（`handleLogin()`）
- ✅ 保存用户角色后（`handleSaveUserRole()`）
- ✅ 删除用户角色后（`handleDeleteUserRole()`）
- ✅ 切换当前用户角色后（`handleSetCurrentUserRole()`）

## 总结

### 问题根源
**初始化应该只在 apikey 登录时进行，而不是每次打开面板的时候。**

当前流程的问题：
1. **不必要的重新加载**：每次打开面板都调用 `loadUserRoles()`，创建新对象并初始化所有属性为默认值
2. **状态丢失**：新对象丢失了内存中的连接状态（`isConnected`、`showDigitalHuman`、`digitalHumanInstance`）
3. **渲染器残留**：渲染器仍然存在于 `rendererManager` 中，但角色对象没有引用它

### 修复方案
**移除打开面板时的 `loadUserRoles()` 调用**，因为：
- 登录时已经加载过了
- 保存/删除/切换角色时会重新加载
- 打开面板只是为了显示，不需要重新加载和初始化

