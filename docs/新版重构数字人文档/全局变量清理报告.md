# 全局变量清理报告

## 清理目标

彻底移除 `appState.avatar.connected` 和 `appState.avatar.instance` 这两个全局变量，所有状态改为使用角色级别的属性。

## 清理清单

### ✅ 1. 修复 `handleDisconnect()` 函数

**位置：** `src/components/ConfigPanel.vue` 第1818行

**修改前：**
```typescript
function handleDisconnect() {
  try {
    appStore.disconnectAvatar()  // ❌ 使用全局状态
    showToastMessage('已断开连接', 'success')
  } catch (error) {
    console.error('断开连接失败:', error)
    showToastMessage('断开连接失败', 'error')
  }
}
```

**修改后：**
```typescript
function handleDisconnect() {
  try {
    // 根据编辑中的角色类型断开连接
    if (showUserRoleEditForm.value && editingUserRole.value) {
      handleDisconnectUserRoleFromList(editingUserRole.value)  // ✅ 使用角色级别逻辑
    } else if (showRoleEditForm.value && editingRole.value) {
      handleDisconnectRoleFromList(editingRole.value)  // ✅ 使用角色级别逻辑
    } else {
      showToastMessage('请先选择要断开的角色', 'error')
    }
  } catch (error) {
    console.error('断开连接失败:', error)
    showToastMessage('断开连接失败', 'error')
  }
}
```

### ✅ 2. 废弃 `appStore.disconnectAvatar()` 函数

**位置：** `src/stores/app.ts` 第60行

**修改前：**
```typescript
disconnectAvatar(): void {
  if (appState.avatar.instance) {  // ❌ 使用全局状态
    avatarService.disconnect(appState.avatar.instance)
    appState.avatar.instance = null
    appState.avatar.connected = false  // ❌ 使用全局状态
    avatarState.value = ''
  }
}
```

**修改后：**
```typescript
disconnectAvatar(): void {
  // 已废弃：数字人连接状态和实例现在存储在角色对象上
  // 此函数保留仅为兼容性，实际应该使用角色级别的断开逻辑
  console.warn('disconnectAvatar() 已废弃，请使用角色级别的断开逻辑')
}
```

### ✅ 3. 修复 `appStore.sendMessage()` 中的 `avatar.instance` 使用

**位置：** `src/stores/app.ts` 第140行

**修改前：**
```typescript
if (avatar.instance) {  // ❌ 使用全局状态
  await this.waitForAvatarReady()
}
```

**修改后：**
```typescript
if (appState.currentUserRole?.digitalHumanInstance) {  // ✅ 使用角色级别状态
  await this.waitForAvatarReady()
}
```

### ✅ 4. 修复 `appStore.waitForAvatarReady()` 函数

**位置：** `src/stores/app.ts` 第212行

**修改前：**
```typescript
private async waitForAvatarReady(): Promise<void> {
  if (!appState.avatar.instance) {  // ❌ 使用全局状态
    return
  }
  if (avatarState.value === 'speak') {
    appState.avatar.instance.think()  // ❌ 使用全局状态
    await delay(APP_CONFIG.SPEAK_INTERRUPT_DELAY)
  }
}
```

**修改后：**
```typescript
private async waitForAvatarReady(): Promise<void> {
  if (!appState.currentUserRole?.digitalHumanInstance) {  // ✅ 使用角色级别状态
    return
  }
  if (avatarState.value === 'speak') {
    appState.currentUserRole.digitalHumanInstance.think()  // ✅ 使用角色级别状态
    await delay(APP_CONFIG.SPEAK_INTERRUPT_DELAY)
  }
}
```

### ✅ 5. 修复 `AvatarRender.vue` 中的 `appState.avatar.connected` 使用

**位置：** `src/components/AvatarRender.vue` 第5行

**修改前：**
```vue
<div 
  ref="containerRef" 
  class="avatar-render"
  :class="{ connected: appState.avatar.connected }"  <!-- ❌ 使用全局状态 -->
  :style="backgroundStyle"
>
```

**修改后：**
```vue
<div 
  ref="containerRef" 
  class="avatar-render"
  :class="{ connected: appState.currentUserRole?.isConnected || appState.currentPartnerRole?.isConnected }"  <!-- ✅ 使用角色级别状态 -->
  :style="backgroundStyle"
>
```

### ✅ 6. 从 `app.ts` 中移除全局变量初始化

**位置：** `src/stores/app.ts` 第12行

**修改前：**
```typescript
avatar: {
  connected: false,  // ❌ 全局变量
  instance: null,   // ❌ 全局变量
  position: 'center' as 'left' | 'center' | 'right',
  positionX: 50,
  positionY: 50,
  scale: 1.0
}
```

**修改后：**
```typescript
avatar: {
  position: 'center' as 'left' | 'center' | 'right',
  positionX: 50,
  positionY: 50,
  scale: 1.0
  // connected 和 instance 已移除，使用 role.isConnected 和 role.digitalHumanInstance
}
```

### ✅ 7. 从类型定义中移除全局变量

**位置：** `src/types/index.ts` 第113行

**修改前：**
```typescript
avatar: {
  connected: boolean  // ❌ 全局变量
  instance: any      // ❌ 全局变量
  position: 'left' | 'center' | 'right'
  positionX: number
  positionY: number
  scale: number
}
```

**修改后：**
```typescript
avatar: {
  position: 'left' | 'center' | 'right'
  positionX: number
  positionY: number
  scale: number
  // connected 和 instance 已移除，使用 role.isConnected 和 role.digitalHumanInstance
}
```

## 清理结果

### ✅ 已完全移除的全局变量

1. **`appState.avatar.connected`** - 已从所有位置移除
2. **`appState.avatar.instance`** - 已从所有位置移除

### ✅ 替换为角色级别状态

所有使用全局变量的地方都已改为使用角色级别的状态：

- `appState.avatar.connected` → `role.isConnected` 或 `appState.currentUserRole?.isConnected`
- `appState.avatar.instance` → `role.digitalHumanInstance` 或 `appState.currentUserRole?.digitalHumanInstance`

### ✅ 验证结果

使用 `grep` 命令验证，确认代码中不再存在 `appState.avatar.connected` 或 `appState.avatar.instance` 的使用。

## 影响范围

### 修改的文件

1. ✅ `src/components/ConfigPanel.vue` - 修复 `handleDisconnect()` 函数
2. ✅ `src/stores/app.ts` - 废弃 `disconnectAvatar()`，修复 `sendMessage()` 和 `waitForAvatarReady()`
3. ✅ `src/components/AvatarRender.vue` - 修复模板中的状态绑定
4. ✅ `src/types/index.ts` - 从类型定义中移除全局变量

### 兼容性说明

- `appStore.disconnectAvatar()` 函数已标记为废弃，但保留函数签名以避免编译错误
- 所有调用 `disconnectAvatar()` 的地方都已改为使用角色级别的断开逻辑

## 总结

✅ **全局变量已完全清理**

所有数字人相关的状态（连接状态、实例）现在都存储在角色对象上：
- `role.isConnected` - 连接状态
- `role.digitalHumanInstance` - SDK 实例
- `role.isConnecting` - 连接中状态
- `role.showDigitalHuman` - 显示状态

每个角色独立管理自己的状态，互不干扰。

