# 同时操作两个数字人的函数汇总

## 一、watch 监听 appState.llm.user 和 appState.llm.apiKey 变化

**文件：** `src/components/AvatarRender.vue`  
**行号：** 297-301

```typescript:297:301:src/components/AvatarRender.vue
// 监听 user 和 apiKey 变化，重新加载角色
watch([() => appState.llm.user, () => appState.llm.apiKey], async () => {
  await loadCurrentPartnerRole()
  await setupPartnerDigitalHumanRenderer(appState.currentPartnerRole)
  await setupUserDigitalHumanRenderer(appState.currentUserRole)
}, { immediate: true })
```

**触发条件：** `appState.llm.user` 或 `appState.llm.apiKey` 发生变化

**执行顺序：**
1. 调用 `loadCurrentPartnerRole()`（空函数，无实际作用）
2. 调用 `setupPartnerDigitalHumanRenderer(appState.currentPartnerRole)`
3. 调用 `setupUserDigitalHumanRenderer(appState.currentUserRole)`

**问题：**
- 如果 `handleConnectRoleFromList` 修改了 `appState.llm.user` 或 `appState.llm.apiKey`，会触发此 watch
- 导致同时重新设置两个数字人渲染器
- `setupUserDigitalHumanRenderer` 会先清理用户角色数字人的状态（`showDigitalHuman = false`），然后重新创建渲染器，但不会恢复 `showDigitalHuman = true`

---

## 二、handleRoleUpdated 事件监听器

**文件：** `src/components/AvatarRender.vue`  
**行号：** 304-308

```typescript:304:308:src/components/AvatarRender.vue
// 监听角色更新事件，重新加载当前角色
const handleRoleUpdated = async () => {
  // 不再需要 loadCurrentPartnerRole 和 loadCurrentUserRole，因为 appState.currentUserRole 和 appState.currentPartnerRole 只在入口处修改
  await setupPartnerDigitalHumanRenderer(appState.currentPartnerRole)
  await setupUserDigitalHumanRenderer(appState.currentUserRole)
}
```

**注册位置：** 第323行
```typescript:323:323:src/components/AvatarRender.vue
window.addEventListener('roleUpdated', handleRoleUpdated)
```

**触发条件：** 其他地方调用 `window.dispatchEvent(new CustomEvent('roleUpdated'))`

**执行顺序：**
1. 调用 `setupPartnerDigitalHumanRenderer(appState.currentPartnerRole)`
2. 调用 `setupUserDigitalHumanRenderer(appState.currentUserRole)`

**问题：**
- 如果 `handleConnectRoleFromList` 触发了 `roleUpdated` 事件，会调用此函数
- 导致同时重新设置两个数字人渲染器
- `setupUserDigitalHumanRenderer` 会先清理用户角色数字人的状态（`showDigitalHuman = false`），然后重新创建渲染器，但不会恢复 `showDigitalHuman = true`

---

## 三、总结

**同时操作两个数字人的函数：**
1. ✅ **watch([() => appState.llm.user, () => appState.llm.apiKey], ...)** - 监听 user 和 apiKey 变化
2. ✅ **handleRoleUpdated()** - 监听 roleUpdated 事件

**关键问题：**
- 这两个函数都会同时调用 `setupPartnerDigitalHumanRenderer` 和 `setupUserDigitalHumanRenderer`
- `setupUserDigitalHumanRenderer` 在重新创建渲染器时，会先清理状态（`showDigitalHuman = false`），然后创建新渲染器，但**不会恢复 `showDigitalHuman = true`**
- 如果用户角色数字人已经连接并显示，调用 `setupUserDigitalHumanRenderer` 会导致容器消失

**需要检查：**
- `handleConnectRoleFromList` 是否修改了 `appState.llm.user` 或 `appState.llm.apiKey`？
- `handleConnectRoleFromList` 是否触发了 `roleUpdated` 事件？

