# 背景管理功能设计文档

## 一、功能概述

背景管理功能允许用户管理应用中的背景图像，包括自动提取Markdown图像、手动管理背景图像库、以及保存当前背景等功能。

## 二、功能模块

### 2.1 Markdown 图像提取开关

**功能描述：**
- 提供一个开关选项，控制是否自动从伙伴回复的Markdown内容中提取最后一张图像作为背景
- 这是当前实现的默认行为，现在可以通过开关控制

**实现要点：**
- 在菜单中添加"背景管理"主菜单项
- 子菜单项："Markdown 图像提取"（带勾选状态）
- 状态存储：使用 `localStorage` 或全局状态管理
- 默认值：开启（保持当前行为）

**交互逻辑：**
- 勾选：启用自动提取，伙伴回复中的最后一张Markdown图像自动设置为背景
- 取消勾选：禁用自动提取，不再自动设置背景

### 2.1.1 截屏到管理器

**功能描述：**
- 在背景管理子菜单中添加"截屏到管理器"选项
- 点击后截取当前浏览器窗口/程序屏幕，并自动保存到背景管理器

**实现要点：**
- 使用浏览器截图API（如 `html2canvas` 或 `dom-to-image`）截取当前页面
- 或者使用系统截图API（需要用户授权）
- 截取后自动上传到背景管理器，可输入名称

**交互逻辑：**
- 点击菜单项后，截取当前屏幕
- 弹出输入框让用户输入背景名称（可选）
- 自动上传并保存到背景管理器
- 显示成功提示

### 2.2 背景图像管理器

**功能描述：**
- 提供一个面板，用于管理用户上传或保存的背景图像
- 支持增删改查、下载、设置当前背景等功能

**面板功能：**

1. **背景图像列表**
   - 显示所有已保存的背景图像
   - 每个背景显示缩略图、名称（可选）、创建时间
   - 支持网格或列表布局

2. **上传背景图像**
   - 支持拖拽上传或点击选择文件
   - 支持常见图片格式（jpg, png, gif, webp等）
   - 文件大小限制（建议50MB，支持高清图）
   - 上传后自动添加到背景库

3. **背景操作**
   - **设置为当前背景**：点击背景图像，设置为当前应用的背景
   - **重命名**：修改背景图像的名称（可选）
   - **下载**：下载背景图像到本地
   - **删除**：从背景库中删除背景图像

4. **清空当前背景**
   - 按钮：清空当前应用的背景（`appState.ui.backgroundImage`）
   - 清空后背景恢复为默认状态

**数据存储：**
- 后端API：`/api/backgrounds`
- 数据库表：`backgrounds`
  - `id`: 主键
  - `api_key`: 用户标识（与用户角色管理一致）
  - `name`: 背景名称（可选）
  - `url`: 背景图像URL（相对路径或完整URL）
  - `created_at`: 创建时间
  - `updated_at`: 更新时间

### 2.3 保存当前背景到背景管理器

**功能描述：**
- 将当前应用的背景图像保存到背景图像管理器
- 如果当前没有背景，按钮禁用或提示

**交互逻辑：**
- 点击菜单项后：
  - 如果 `appState.ui.backgroundImage` 有值：
    - 弹出输入框，让用户输入背景名称（可选）
    - 确认后保存到背景库
    - 显示成功提示
  - 如果 `appState.ui.backgroundImage` 为空：
    - 显示提示："当前没有背景图像"

## 三、数据结构

### 3.1 前端状态

```typescript
// 在 appState 或组件状态中添加
interface BackgroundState {
  autoExtractMarkdownImage: boolean  // Markdown图像提取开关
}

// 背景图像数据模型
interface Background {
  id: number
  apiKey: string
  name?: string
  url: string
  createdAt: number
  updatedAt: number
}
```

### 3.2 后端数据库表

```sql
CREATE TABLE IF NOT EXISTS backgrounds (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  api_key TEXT NOT NULL,              -- 用户账号（登录的apiKey）
  name TEXT,                           -- 背景名称（可选）
  url TEXT NOT NULL,                   -- 背景图像URL
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
)
```

## 四、API 设计

### 4.1 获取背景列表

```
GET /api/backgrounds?apiKey={apiKey}
Response: {
  data: Background[]
}
```

### 4.2 上传背景图像

```
POST /api/backgrounds
Body (FormData): {
  apiKey: string,
  name?: string,
  file: File
}
Response: {
  data: Background
}
```

### 4.3 更新背景信息

```
PUT /api/backgrounds/:id?apiKey={apiKey}
Body: {
  name?: string
}
Response: {
  data: Background
}
```

### 4.4 删除背景

```
DELETE /api/backgrounds/:id?apiKey={apiKey}
Response: {
  success: boolean
}
```

### 4.5 保存当前背景（从URL创建）

```
POST /api/backgrounds/from-url
Body: {
  apiKey: string,
  name?: string,
  url: string
}
Response: {
  data: Background
}
```

## 五、UI/UX 设计

### 5.1 菜单结构

```
背景管理
├── ✓ Markdown 图像提取
├── 背景图像管理器
├── 保存当前背景
└── 截屏到管理器
```

### 5.2 背景图像管理器面板

**布局：**
- 模态框形式，类似角色管理面板
- 顶部：标题"背景图像管理器" + 关闭按钮
- 工具栏：
  - 上传按钮（支持拖拽）
  - 清空当前背景按钮
- 内容区：
  - 背景图像网格（响应式布局）
  - 每个背景卡片：
    - 缩略图（可点击设置为当前背景）
    - 名称（可编辑）
    - 操作按钮：重命名、下载、删除
- 底部：关闭按钮

**交互细节：**
- 背景卡片悬停显示操作按钮（小图标式）
- 点击背景卡片：仅预览，不设置背景
- 点击"设置"按钮：设置为当前背景
- 点击"重命名"按钮：弹出输入框重命名
- 点击"下载"按钮：下载背景图像
- 点击"删除"按钮：删除背景（需确认）

**按钮样式：**
- 使用小图标（如：⚙️设置、✏️重命名、⬇️下载、🗑️删除）
- 按钮尺寸：约24x24px
- 图标颜色：白色或半透明
- 悬停时高亮显示

## 六、实现步骤

### 6.1 第一阶段：基础功能
1. 添加菜单项和子菜单
2. 实现 Markdown 图像提取开关
3. 创建背景图像管理器面板UI
4. 修复上传图像功能
5. 优化背景卡片交互（点击卡片不设置，只有点击"设置"按钮才设置）
6. 优化按钮样式（改为小图标式）
7. 添加截屏到管理器功能

### 6.2 第二阶段：后端API
1. 创建数据库表
2. 实现背景图像的增删改查API
3. 实现文件上传功能

### 6.3 第三阶段：完整功能
1. 实现背景图像列表显示
2. 实现上传、删除、重命名功能
3. 实现设置为当前背景功能
4. 实现保存当前背景功能
5. 实现清空当前背景功能

### 6.4 第四阶段：优化
1. 添加拖拽上传
2. 优化图片加载性能（懒加载、缩略图）
3. 添加背景预览功能
4. 添加批量操作功能

## 七、技术要点

### 7.1 文件上传
- 使用 `FormData` 上传文件
- 服务器端保存文件到 `uploads/backgrounds/` 目录
- 返回相对路径URL
- **注意：需要确保文件上传事件正确绑定，检查input元素的change事件**

### 7.5 屏幕截图
- 使用 `html2canvas` 库截取当前页面
- 或者使用浏览器原生截图API（如果支持）
- 将截图转换为Blob，然后上传到服务器
- 支持全屏截图或指定区域截图

### 7.2 图片处理
- 生成缩略图（可选，提升性能）
- 支持多种图片格式
- 文件大小限制和验证

### 7.3 状态管理
- Markdown图像提取开关状态持久化
- 背景列表缓存
- 当前背景状态同步

### 7.4 性能优化
- 背景列表懒加载
- 缩略图预加载
- 图片压缩（可选）

## 八、边界情况处理

1. **没有背景图像时**
   - 显示空状态提示
   - 引导用户上传背景

2. **上传失败**
   - 显示错误提示
   - 允许重试
   - **检查文件上传事件绑定是否正确**

3. **网络错误**
   - 显示友好错误提示
   - 提供重试机制

4. **文件格式不支持**
   - 上传前验证文件类型
   - 显示错误提示

5. **文件过大**
   - 上传前验证文件大小
   - 显示错误提示和建议

6. **截图失败**
   - 显示错误提示
   - 提供重试机制
   - 如果浏览器不支持截图，提示用户使用其他方式

## 九、后续扩展

1. **背景分类/标签**
   - 支持为背景添加分类或标签
   - 支持按分类筛选

2. **背景预览**
   - 点击背景显示大图预览
   - 支持全屏预览

3. **背景编辑**
   - 简单的图片编辑功能（裁剪、滤镜等）

4. **背景分享**
   - 导出背景配置
   - 导入背景配置

5. **默认背景设置**
   - 设置应用启动时的默认背景

