# 数字人显示状态变量必要性分析

## 一、当前实现

### 1.1 变量定义

```typescript
// 在 appState 中
appState.avatar.showPartnerDigitalHuman: boolean
appState.avatar.showUserDigitalHuman: boolean
```

### 1.2 使用场景

#### 场景1：容器创建条件（模板中）
```vue
<div 
  v-if="currentPartnerRoleType === 'digital_human' && appState.avatar.showPartnerDigitalHuman && currentPartnerRole"
  :id="partnerDigitalHumanContainerId"
  class="sdk-container"
/>
```

#### 场景2：角色切换时设置
```typescript
// 在 setupPartnerDigitalHumanRenderer 中
appState.avatar.showPartnerDigitalHuman = true  // 确保容器被创建
```

#### 场景3：用户点击头像切换显示/隐藏
```typescript
// 在 toggleIllustration 中
renderer.toggle()
appState.avatar.showPartnerDigitalHuman = renderer.getState().visible
```

#### 场景4：连接/断开时设置
```typescript
// 连接成功后
appState.avatar.showPartnerDigitalHuman = true

// 断开后
appState.avatar.showPartnerDigitalHuman = false
```

## 二、问题分析

### 2.1 循环依赖问题

**问题**：容器创建依赖 `showPartnerDigitalHuman`，但连接时需要容器已存在。

**当前流程**：
1. 角色切换 → `setupPartnerDigitalHumanRenderer` → 设置 `showPartnerDigitalHuman = true` → 容器创建
2. 连接 → 需要容器存在 → 容器已创建 ✅

**问题流程**：
1. 连接 → 需要容器存在 → 容器未创建（因为 `showPartnerDigitalHuman` 可能为 `false`） ❌

### 2.2 变量职责混乱

`showPartnerDigitalHuman` 同时承担两个职责：
1. **控制容器创建**（通过 `v-if`）
2. **控制容器显示/隐藏**（用户点击头像时）

这两个职责是冲突的：
- 如果用于控制创建，容器应该始终存在（一旦创建就不销毁）
- 如果用于控制显示/隐藏，容器应该可以随时创建和销毁

## 三、立绘的实现方式（参考）

### 3.1 立绘的显示/隐藏

```vue
<div 
  v-if="showPartnerIllustration && currentPartnerRoleType === 'illustration' && currentPartnerRoleAvatar"
  class="illustration-container"
>
```

**特点**：
- `showPartnerIllustration` 只用于控制显示/隐藏
- 容器在显示时创建，隐藏时销毁（通过 `v-if`）
- 立绘是静态图片，创建/销毁成本低

### 3.2 数字人的特殊性

**数字人的特点**：
- 需要连接SDK（耗时操作）
- 连接后需要保持连接状态（不能频繁断开/重连）
- 容器创建成本高（需要等待Vue渲染）

**数字人的需求**：
- 容器应该在角色切换时创建（确保连接时容器已存在）
- 显示/隐藏应该只控制容器的可见性，不销毁容器（保持连接状态）

## 四、解决方案

### 4.1 方案1：分离容器创建和显示/隐藏（推荐）

**容器创建条件**：只依赖角色类型和角色存在
```vue
<div 
  v-if="currentPartnerRoleType === 'digital_human' && currentPartnerRole"
  :id="partnerDigitalHumanContainerId"
  class="sdk-container"
  :class="{ 'hidden': !appState.avatar.showPartnerDigitalHuman }"
/>
```

**显示/隐藏控制**：使用CSS类控制
```css
.sdk-container.hidden {
  display: none;
}
```

**优点**：
- ✅ 容器在角色切换时自动创建（不依赖 `showPartnerDigitalHuman`）
- ✅ 显示/隐藏只控制CSS，不销毁容器（保持连接状态）
- ✅ 职责清晰：容器创建 vs 显示/隐藏

**缺点**：
- ⚠️ 容器始终存在（即使隐藏），占用DOM资源（但这是必要的，因为要保持连接）

### 4.2 方案2：使用 `v-show` 替代 `v-if`

**容器创建条件**：始终创建（角色切换时）
```vue
<div 
  v-show="currentPartnerRoleType === 'digital_human' && appState.avatar.showPartnerDigitalHuman && currentPartnerRole"
  :id="partnerDigitalHumanContainerId"
  class="sdk-container"
/>
```

**显示/隐藏控制**：通过 `v-show` 控制（CSS `display: none`）

**优点**：
- ✅ 容器在角色切换时创建（通过设置 `showPartnerDigitalHuman = true`）
- ✅ 显示/隐藏只控制CSS，不销毁容器
- ✅ 保持现有变量结构

**缺点**：
- ⚠️ 仍然依赖 `showPartnerDigitalHuman` 来控制容器创建（但这是可以接受的，因为需要在角色切换时设置）

### 4.3 方案3：移除变量，使用渲染器状态

**容器创建条件**：只依赖角色类型
```vue
<div 
  v-if="currentPartnerRoleType === 'digital_human' && currentPartnerRole"
  :id="partnerDigitalHumanContainerId"
  class="sdk-container"
  :class="{ 'hidden': !partnerDigitalHumanRenderer?.getState().visible }"
/>
```

**显示/隐藏控制**：通过渲染器的 `getState().visible` 控制

**优点**：
- ✅ 不需要额外的状态变量
- ✅ 状态来源单一（渲染器）

**缺点**：
- ⚠️ 需要访问渲染器实例（可能为 `null`）
- ⚠️ 需要处理渲染器不存在的情况

## 五、推荐方案

### 5.1 推荐：方案2（使用 `v-show`）

**理由**：
1. **最小改动**：只需要将 `v-if` 改为 `v-show`，保持现有变量结构
2. **职责清晰**：`showPartnerDigitalHuman` 只用于控制显示/隐藏，容器创建由角色切换触发
3. **符合需求**：容器在角色切换时创建（通过设置 `showPartnerDigitalHuman = true`），显示/隐藏只控制CSS

### 5.2 实现步骤

1. **修改模板**：将 `v-if` 改为 `v-show`
   ```vue
   <div 
     v-show="currentPartnerRoleType === 'digital_human' && appState.avatar.showPartnerDigitalHuman && currentPartnerRole"
     :id="partnerDigitalHumanContainerId"
     class="sdk-container"
   />
   ```

2. **确保角色切换时设置变量**：
   ```typescript
   // 在 setupPartnerDigitalHumanRenderer 中
   if (role && role.type === 'digital_human') {
     appState.avatar.showPartnerDigitalHuman = true  // 确保容器被创建
   } else {
     appState.avatar.showPartnerDigitalHuman = false  // 非数字人角色时隐藏
   }
   ```

3. **保持显示/隐藏逻辑**：
   ```typescript
   // 在 toggleIllustration 中
   renderer.toggle()
   appState.avatar.showPartnerDigitalHuman = renderer.getState().visible
   ```

## 六、变量必要性结论

### 6.1 `showPartnerDigitalHuman` 和 `showUserDigitalHuman` 的必要性

**结论：必要，但职责应该明确**

**必要的原因**：
1. **控制显示/隐藏**：用户点击头像时需要切换数字人的显示/隐藏
2. **保持连接状态**：数字人连接后需要保持连接，不能频繁断开/重连
3. **与立绘一致**：立绘使用 `showPartnerIllustration`，数字人使用 `showPartnerDigitalHuman`，保持一致性

**职责应该明确**：
- ✅ **主要职责**：控制容器的显示/隐藏（通过 `v-show` 或 CSS类）
- ✅ **次要职责**：在角色切换时确保容器被创建（通过设置为 `true`）

**不应该的职责**：
- ❌ 不应该用于控制容器的创建/销毁（应该使用 `v-show` 而不是 `v-if`）

### 6.2 与立绘的对比

| 特性 | 立绘 | 数字人 |
|------|------|--------|
| 创建成本 | 低（静态图片） | 高（需要连接SDK） |
| 连接状态 | 不需要 | 需要保持 |
| 显示/隐藏方式 | `v-if`（创建/销毁） | `v-show`（CSS控制） |
| 状态变量 | `showPartnerIllustration` | `showPartnerDigitalHuman` |
| 变量职责 | 控制创建/销毁 | 控制显示/隐藏 |

## 七、最终建议

1. **保留变量**：`showPartnerDigitalHuman` 和 `showUserDigitalHuman` 是必要的
2. **修改实现**：将 `v-if` 改为 `v-show`，确保容器在角色切换时创建，显示/隐藏只控制CSS
3. **明确职责**：变量只用于控制显示/隐藏，容器创建由角色切换触发

